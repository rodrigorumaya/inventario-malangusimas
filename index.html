<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malangu√≠simas - Sistema de Inventario</title>
    
    <!-- iOS App Icon -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Malangu√≠simas">
    
    <!-- Theme color for mobile browsers -->
    <meta name="theme-color" content="#d73027">
    
    <!-- Favicon simple con emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üå∂Ô∏è</text></svg>">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary: #d73027;
            --primary-dark: #a21e1e;
            --secondary: #ff6b35;
            --accent: #ffa500;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --bg-gradient: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            min-height: 100vh;
            color: var(--dark);
            position: relative;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ff6b35' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            z-index: -1;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            animation: fadeIn 0.6s ease;
        }
        
        .login-card {
            background: white;
            border-radius: 30px;
            overflow: hidden;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.2);
            text-align: center;
            max-width: 450px;
            width: 100%;
            transform: translateY(0);
            transition: var(--transition);
        }
        
        .login-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.25);
        }
        
        .login-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 60px 40px;
            position: relative;
            overflow: hidden;
        }
        
        .login-header::before {
            content: 'üå∂Ô∏è';
            position: absolute;
            font-size: 200px;
            opacity: 0.1;
            top: -50px;
            right: -50px;
            transform: rotate(-15deg);
        }
        
        .login-header h1 {
            font-size: 3em;
            color: white;
            font-weight: 800;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            margin: 0;
            letter-spacing: -2px;
            position: relative;
            z-index: 1;
        }
        
        .login-body {
            padding: 50px 40px;
        }
        
        .login-body p {
            color: #666;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .tagline {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.3em;
            margin-bottom: 40px;
            letter-spacing: 3px;
            text-transform: uppercase;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: none;
            animation: fadeIn 0.6s ease;
        }
        
        .container.active {
            display: block;
        }
        
        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 30px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
        }
        
        .header-logo {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 25px 50px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(215, 48, 39, 0.3);
            transform: rotate(-2deg);
            transition: var(--transition);
        }
        
        .header-logo:hover {
            transform: rotate(0deg) scale(1.05);
        }
        
        .header h1 {
            font-size: 3em;
            margin: 0;
            color: white;
            text-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            letter-spacing: -1px;
            font-weight: 800;
        }
        
        .header p {
            font-size: 1.3em;
            color: #666;
            margin: 10px 0;
            font-weight: 500;
        }
        
        .header .tagline {
            color: var(--primary);
            font-weight: 800;
            font-size: 1.2em;
            letter-spacing: 3px;
            text-transform: uppercase;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .header-buttons {
            margin-top: 25px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 600;
            z-index: 1500;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sync-status::before {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .sync-status.offline {
            background: var(--danger);
        }
        
        .sync-status.offline::before {
            animation: none;
        }
        
        .sync-status.syncing {
            background: var(--warning);
        }
        
        .sync-status.syncing::before {
            animation: spin 1s linear infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }
        
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 25px;
            padding: 35px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-10px);
            box-shadow: var(--hover-shadow);
        }
        
        .card:hover::before {
            transform: scaleX(1);
        }
        
        .card h2 {
            color: var(--dark);
            margin-bottom: 25px;
            font-size: 1.8em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card h2::after {
            content: '';
            flex: 1;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), transparent);
            margin-left: 10px;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            width: 100%;
            margin: 8px 0;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 5px 15px rgba(215, 48, 39, 0.3);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(215, 48, 39, 0.4);
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--info) 0%, #2980b9 100%);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary:hover {
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }
        
        .btn-warning:hover {
            box-shadow: 0 8px 25px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #229954 100%);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }
        
        .btn-success:hover {
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-group input, 
        .input-group select, 
        .input-group textarea {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 16px;
            transition: var(--transition);
            background: #f8f9fa;
            font-family: 'Poppins', sans-serif;
        }
        
        .input-group input:focus, 
        .input-group select:focus, 
        .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(215, 48, 39, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            overflow-y: auto;
            padding: 20px 0;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            background: white;
            margin: auto;
            padding: 40px;
            border-radius: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
            position: relative;
        }
        
        .modal-content::-webkit-scrollbar {
            width: 10px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .close {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            color: #999;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f8f9fa;
            transition: var(--transition);
        }
        
        .close:hover {
            color: white;
            background: var(--danger);
            transform: rotate(90deg);
        }
        
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }
        
        .product-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 25px;
            border-left: 5px solid var(--secondary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .product-card::before {
            content: 'üå∂Ô∏è';
            position: absolute;
            font-size: 80px;
            opacity: 0.05;
            bottom: -20px;
            right: -20px;
            transform: rotate(-15deg);
        }
        
        .product-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
            border-left-width: 8px;
        }
        
        .product-name {
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 1.3em;
            text-transform: capitalize;
        }
        
        .stock-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .stock-info span:first-child {
            font-weight: 600;
            color: #666;
        }
        
        .stock-badge {
            padding: 8px 16px;
            border-radius: 50px;
            color: white;
            font-size: 0.85em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
        
        .stock-good { 
            background: linear-gradient(135deg, var(--success) 0%, #229954 100%); 
        }
        .stock-low { 
            background: linear-gradient(135deg, var(--warning) 0%, #d68910 100%); 
        }
        .stock-out { 
            background: linear-gradient(135deg, var(--danger) 0%, #c0392b 100%); 
        }
        
        .price-list {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 2px solid #dee2e6;
            align-items: center;
        }
        
        .price-row:last-child {
            border-bottom: none;
            margin-top: 10px;
            padding-top: 20px;
            border-top: 3px solid var(--primary);
        }
        
        .price-row strong {
            color: var(--dark);
            font-weight: 600;
            font-size: 1.1em;
        }
        
        .price-row span {
            color: #666;
            font-weight: 500;
            background: white;
            padding: 8px 16px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .alert {
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid;
            position: relative;
            font-weight: 500;
        }
        
        .alert::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            opacity: 0.1;
            border-radius: inherit;
        }
        
        .alert-success {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }
        
        .alert-warning {
            background-color: var(--warning);
            border-color: var(--warning);
            color: white;
        }
        
        .alert-error {
            background-color: var(--danger);
            border-color: var(--danger);
            color: white;
        }
        
        .alert-info {
            background-color: var(--info);
            border-color: var(--info);
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .stat-card:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        
        .stat-number {
            font-size: 3em;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .stat-label {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }
        
        .hidden {
            display: none;
        }
        
        .btn-sm {
            padding: 10px 20px;
            font-size: 14px;
            width: auto;
            display: inline-block;
        }
        
        .carrito-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .carrito-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: var(--transition);
        }
        
        .carrito-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .carrito-vacio {
            text-align: center;
            color: #999;
            padding: 40px;
            font-size: 1.1em;
            font-weight: 500;
        }
        
        .total-venta {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            font-weight: 600;
            text-align: right;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid #ffd93d;
        }
        
        .total-venta div {
            margin: 8px 0;
        }
        
        .total-venta hr {
            border: none;
            border-top: 2px solid #ffd93d;
            margin: 15px 0;
        }
        
        .btn-inline {
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-inline:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }
        
        /* Tablas mejoradas */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 14px;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        th {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 15px;
            text-align: left;
            z-index: 10;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        tr:hover td {
            background: #f8f9fa;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        /* Animaci√≥n para elementos urgentes */
        @keyframes urgentPulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0);
            }
        }
        
        .pedido-urgente {
            animation: urgentPulse 2s infinite;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header-logo {
                padding: 20px 30px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px auto;
                padding: 30px 20px;
                max-height: 85vh;
            }
            
            .inventory-grid {
                grid-template-columns: 1fr;
                max-height: 50vh;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .price-row {
                flex-direction: column;
                text-align: center;
                gap: 10px;
            }
        }
        
        /* Animaciones adicionales */
        .fade-in {
            animation: fadeIn 0.6s ease;
        }
        
        .slide-up {
            animation: slideUp 0.6s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help;
        }
        
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            animation: tooltipFade 0.3s ease forwards;
        }
        
        @keyframes tooltipFade {
            to { opacity: 1; transform: translateX(-50%) translateY(-5px); }
        }
        
        /* Loading spinner */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginContainer" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>üå∂Ô∏è Malangu√≠simas</h1>
            </div>
            <div class="login-body">
                <p>Sistema de Inventario y Ventas</p>
                <p class="tagline">"MALANGAS SUPREMACY"</p>
                <form onsubmit="iniciarSesion(event)">
                    <div class="input-group">
                        <label>C√≥digo de Acceso</label>
                        <input type="password" id="codigoAcceso" placeholder="Ingresa el c√≥digo" required autocomplete="off">
                    </div>
                    <button type="submit" class="btn">
                        üîê INGRESAR AL SISTEMA
                    </button>
                </form>
                <div id="loginError" class="alert alert-error hidden" style="margin-top: 20px;">
                    ‚ùå C√≥digo incorrecto. Intenta nuevamente.
                </div>
            </div>
        </div>
    </div>

    <!-- Sync Status Indicator -->
    <div id="syncStatus" class="sync-status hidden">
        <span id="syncText">Sincronizado</span>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-logo">
                <h1>üå∂Ô∏è Malangu√≠simas</h1>
            </div>
            <p>Sistema de Inventario y Ventas</p>
            <p class="tagline">"MALANGAS SUPREMACY"</p>
            <div class="header-buttons">
                <button class="btn btn-secondary btn-sm" onclick="sincronizarDatos()">
                    üîÑ Sincronizar
                </button>
                <button class="btn btn-danger btn-sm" onclick="cerrarSesion()">
                    üö™ Salir
                </button>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div class="main-grid">
            <!-- Inventario -->
            <div class="card slide-up">
                <h2>üì¶ Inventario</h2>
                <button class="btn" onclick="mostrarInventario()">Ver Inventario Completo</button>
                <button class="btn btn-secondary" onclick="mostrarModal('agregarStockModal')">‚ûï Agregar Stock</button>
                <button class="btn btn-danger" onclick="mostrarModal('quitarStockModal')">‚ûñ Quitar Stock</button>
                <button class="btn btn-warning" onclick="mostrarModal('convertirStockModal')">üîÑ Convertir Tama√±os</button>
                <button class="btn btn-warning" onclick="mostrarModal('actualizarCostosModal')">üí∞ Actualizar Costos</button>
            </div>

            <!-- Ventas -->
            <div class="card slide-up" style="animation-delay: 0.1s;">
                <h2>üõí Ventas</h2>
                <button class="btn" onclick="prepararVentaMultiple('menudeo')">üõí Venta Menudeo</button>
                <button class="btn" onclick="prepararVentaMultiple('mayoreo')">üè™ Venta Mayoreo</button>
                <button class="btn btn-secondary" onclick="mostrarModal('nuevaRecepcionModal')">üì¶ Registrar Recepci√≥n</button>
                <button class="btn btn-warning" onclick="mostrarRecepcionesPendientes()">üìã Ver Recepciones</button>
                <button class="btn btn-warning" onclick="mostrarModal('regaladaModal')">üéÅ Registrar Regalada</button>
                <button class="btn btn-secondary" onclick="mostrarModal('envioModal')">üì¶ Registrar Env√≠o</button>
                <button class="btn btn-danger" onclick="mostrarCancelarVenta()">‚ùå Cancelar Venta</button>
                <button class="btn btn-secondary" onclick="mostrarReportes()">üìä Ver Reportes</button>
            </div>

            <!-- Informaci√≥n -->
            <div class="card slide-up" style="animation-delay: 0.2s;">
                <h2>üí≤ Precios</h2>
                <div class="price-list">
                    <div class="price-row">
                        <strong>Tama√±o 50g</strong>
                        <span>Mayoreo $20 | Menudeo $25</span>
                    </div>
                    <div class="price-row">
                        <strong>Tama√±o 100g</strong>
                        <span>Mayoreo $33 | Menudeo $40</span>
                    </div>
                    <div class="price-row">
                        <strong>üí∞ Costos Base</strong>
                        <span>50g: $15 | 100g: $23</span>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="mostrarModal('gastosModal')">üí∏ Registrar Gasto</button>
                <button class="btn btn-success" onclick="mostrarFlujoEfectivo()">üí∞ Flujo de Efectivo</button>
            </div>
        </div>

        <!-- Nueva secci√≥n de An√°lisis -->
        <div class="card slide-up" style="animation-delay: 0.3s;">
            <h2>üìà An√°lisis y Tendencias</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                <button class="btn btn-info" onclick="mostrarTendencias()">üìä Ver Tendencias</button>
                <button class="btn btn-success" onclick="mostrarRecomendaciones()">üí° Recomendaciones</button>
            </div>
        </div>

        <!-- Estad√≠sticas R√°pidas -->
        <div class="card slide-up" style="animation-delay: 0.4s;">
            <h2>üìä Estad√≠sticas del D√≠a</h2>
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="ventasHoy">0</div>
                    <div class="stat-label">Ventas Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ingresosHoy">$0</div>
                    <div class="stat-label">Ingresos Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="productosStock">0</div>
                    <div class="stat-label">Productos en Stock</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ultimaSinc">--:--</div>
                    <div class="stat-label">√öltima Sincronizaci√≥n</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar Stock -->
    <div id="agregarStockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('agregarStockModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">‚ûï Agregar Stock</h2>
            <form onsubmit="agregarStock(event)">
                <div class="input-group">
                    <label>Sabor</label>
                    <select id="saborStock" required>
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tama√±o</label>
                    <select id="tama√±oStock" required>
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Cantidad a agregar</label>
                    <input type="number" id="cantidadStock" min="1" required placeholder="0">
                </div>
                <button type="submit" class="btn btn-success">‚úÖ Agregar Stock</button>
            </form>
        </div>
    </div>

    <!-- Modal: Quitar Stock -->
    <div id="quitarStockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('quitarStockModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">‚ûñ Quitar Stock</h2>
            <form onsubmit="quitarStock(event)">
                <div class="input-group">
                    <label>Sabor</label>
                    <select id="saborQuitar" required onchange="mostrarStockActual()">
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tama√±o</label>
                    <select id="tama√±oQuitar" required onchange="mostrarStockActual()">
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                <div id="stockActualInfo" class="alert alert-warning hidden" style="margin: 20px 0;">
                    Stock actual: <strong id="stockActualTexto">0</strong> unidades
                </div>
                <div class="input-group">
                    <label>Cantidad a quitar</label>
                    <input type="number" id="cantidadQuitar" min="1" required placeholder="0">
                </div>
                <div class="input-group">
                    <label>Motivo</label>
                    <select id="motivoQuitar">
                        <option value="da√±ado">Producto da√±ado</option>
                        <option value="vencido">Producto vencido</option>
                        <option value="perdida">P√©rdida/Robo</option>
                        <option value="ajuste">Ajuste de inventario</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-danger">‚ùå Quitar del Stock</button>
            </form>
        </div>
    </div>

    <!-- Modal: Venta M√∫ltiple -->
    <div id="ventaMultipleModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="cerrarModal('ventaMultipleModal')">&times;</span>
            <h2 id="tituloVentaMultiple" style="color: var(--dark); margin-bottom: 30px;">üõí Venta</h2>
            
            <!-- Agregar productos al carrito -->
            <div style="background: linear-gradient(135deg, #f0f0f0, #e0e0e0); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                <h3 style="margin: 0 0 15px 0; color: var(--dark);">Agregar Producto</h3>
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
                    <div class="input-group" style="margin: 0;">
                        <label>Sabor</label>
                        <select id="saborVentaMultiple">
                            <option value="">Selecciona</option>
                            <option value="fuego">üî• Fuego</option>
                            <option value="misterio">üåü Misterio</option>
                            <option value="habanero">ü´ë Habanero</option>
                            <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                            <option value="adobadas">üçÖ Adobadas</option>
                            <option value="naturales">üßÇ Naturales</option>
                            <option value="especias">‚ú® Especias</option>
                            <option value="chipotle">üî• Chipotle</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin: 0;">
                        <label>Tama√±o</label>
                        <select id="tama√±oVentaMultiple">
                            <option value="">Tama√±o</option>
                            <option value="50">50g</option>
                            <option value="100">100g</option>
                        </select>
                    </div>
                    <div class="input-group" style="margin: 0;">
                        <label>Cantidad</label>
                        <input type="number" id="cantidadVentaMultiple" min="1" placeholder="0">
                    </div>
                    <button type="button" class="btn btn-secondary" style="margin: 0; height: 48px;" onclick="agregarAlCarrito()">
                        ‚ûï AGREGAR
                    </button>
                </div>
            </div>
            
            <!-- Carrito de compras -->
            <h3 style="color: var(--dark); margin-bottom: 15px;">üõí Carrito de Compra</h3>
            <div class="carrito-container">
                <div id="carritoVenta">
                    <div class="carrito-vacio">El carrito est√° vac√≠o</div>
                </div>
            </div>
            
            <!-- Costo personalizado del pedido -->
            <div class="input-group">
                <label style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="costoPersonalizado" onchange="toggleCostoPersonalizado()" style="width: auto;">
                    Usar costo de producci√≥n personalizado para este pedido
                </label>
            </div>
            
            <div id="costoPersonalizadoContainer" class="input-group hidden">
                <label>Costo total de producci√≥n del pedido</label>
                <input type="number" id="costoTotalPedido" step="0.01" min="0" placeholder="0.00" onchange="actualizarTotalesCarrito()">
                <small style="color: #666; display: block; margin-top: 5px;">Este costo reemplazar√° el c√°lculo autom√°tico basado en costos individuales</small>
            </div>
            
            <!-- Resumen de totales -->
            <div class="total-venta">
                <div id="resumenVenta">
                    <div>Subtotal: $<span id="subtotalVenta">0.00</span></div>
                    <div id="costoVentaDiv">Costo estimado: $<span id="costoVenta">0.00</span></div>
                    <div style="color: var(--success); font-weight: 700;">Ganancia estimada: $<span id="gananciaVenta">0.00</span></div>
                    <hr>
                    <div style="font-size: 1.3em; font-weight: 700;">Total a cobrar: $<span id="totalVenta">0.00</span></div>
                </div>
            </div>
            
            <button type="button" class="btn btn-success" onclick="confirmarVentaMultiple()" id="btnConfirmarVenta" disabled style="margin-top: 20px;">
                üí∞ CONFIRMAR VENTA
            </button>
        </div>
    </div>

    <!-- Modal: Actualizar Costos -->
    <div id="actualizarCostosModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('actualizarCostosModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üí∞ Actualizar Costos Base</h2>
            <p style="color: #666; margin-bottom: 25px;">
                Estos son los costos base de referencia. Puedes ajustar el costo real al momento de cada venta.
            </p>
            <form onsubmit="actualizarCostos(event)">
                <div class="input-group">
                    <label>Sabor</label>
                    <select id="saborCosto" required>
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tama√±o</label>
                    <select id="tama√±oCosto" required>
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Costo base de producci√≥n</label>
                    <input type="number" id="costoProduccion" step="0.01" min="0" required placeholder="0.00">
                </div>
                <button type="submit" class="btn btn-warning">‚úÖ Actualizar Costo Base</button>
            </form>
        </div>
    </div>

    <!-- Modal: Registrar Gasto -->
    <div id="gastosModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('gastosModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üí∏ Registrar Gasto</h2>
            <form onsubmit="registrarGasto(event)">
                <div class="input-group">
                    <label>Concepto</label>
                    <input type="text" id="conceptoGasto" required placeholder="Ej: Compra de chiles">
                </div>
                <div class="input-group">
                    <label>Monto</label>
                    <input type="number" id="montoGasto" step="0.01" min="0" required placeholder="0.00">
                </div>
                <div class="input-group">
                    <label>Categor√≠a</label>
                    <select id="categoriaGasto">
                        <option value="operativo">Operativo</option>
                        <option value="materia_prima">Materia Prima</option>
                        <option value="transporte">Transporte</option>
                        <option value="equipamiento">Equipamiento</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-secondary">‚úÖ Registrar Gasto</button>
            </form>
        </div>
    </div>

    <!-- Modal: Registrar Regalada -->
    <div id="regaladaModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('regaladaModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üéÅ Registrar Regalada (Muestra)</h2>
            <form onsubmit="registrarRegalada(event)">
                <div class="input-group">
                    <label>Sabor</label>
                    <select id="saborRegalada" required>
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tama√±o</label>
                    <select id="tama√±oRegalada" required>
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Cantidad regalada</label>
                    <input type="number" id="cantidadRegalada" min="1" required placeholder="0">
                </div>
                <div class="input-group">
                    <label>Punto de venta (opcional)</label>
                    <input type="text" id="puntoVenta" placeholder="Ej: Tienda El Ahorro">
                </div>
                <button type="submit" class="btn btn-warning">üéÅ Registrar Regalada</button>
            </form>
        </div>
    </div>

    <!-- Modal: Convertir Stock -->
    <div id="convertirStockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('convertirStockModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üîÑ Convertir Tama√±os</h2>
            <form onsubmit="convertirStock(event)">
                <div class="input-group">
                    <label>Tipo de conversi√≥n</label>
                    <select id="tipoConversion" required onchange="actualizarInfoConversion()">
                        <option value="">Selecciona tipo</option>
                        <option value="100a50">üì¶ 100g ‚Üí 50g (1 bolsa grande = 2 bolsas chicas)</option>
                        <option value="50a100">üì¶ 50g ‚Üí 100g (2 bolsas chicas = 1 bolsa grande)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Sabor</label>
                    <select id="saborConvertir" required onchange="mostrarStockConversion()">
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                <div id="stockConversionInfo" class="alert alert-info hidden" style="margin: 20px 0;">
                    <div id="stockOrigenTexto"></div>
                    <div id="conversionResultado" style="margin-top: 10px;"></div>
                </div>
                <div class="input-group">
                    <label id="labelCantidadConvertir">Cantidad a convertir</label>
                    <input type="number" id="cantidadConvertir" min="1" required onchange="calcularResultadoConversion()" placeholder="0">
                </div>
                <button type="submit" class="btn btn-warning">üîÑ Realizar Conversi√≥n</button>
            </form>
        </div>
    </div>

    <!-- Modal: Registrar Env√≠o -->
    <div id="envioModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('envioModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üì¶ Registrar Env√≠o</h2>
            <form onsubmit="registrarEnvio(event)">
                <div class="input-group">
                    <label>Cliente/Destino</label>
                    <input type="text" id="clienteEnvio" required placeholder="Nombre del cliente o destino">
                </div>
                <div class="input-group">
                    <label>Sabor</label>
                    <select id="saborEnvio" required>
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tama√±o</label>
                    <select id="tama√±oEnvio" required onchange="actualizarPrecioEnvio()">
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Cantidad</label>
                    <input type="number" id="cantidadEnvio" min="1" required onchange="calcularTotalEnvio()" placeholder="0">
                </div>
                <div class="input-group">
                    <label>Tipo de precio</label>
                    <select id="tipoPrecioEnvio" required onchange="calcularTotalEnvio()">
                        <option value="mayoreo">Mayoreo</option>
                        <option value="menudeo">Menudeo</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Costo de env√≠o</label>
                    <input type="number" id="costoEnvio" step="0.01" min="0" required onchange="calcularTotalEnvio()" placeholder="0.00">
                </div>
                <div class="alert alert-info" style="margin: 20px 0;">
                    <strong>Subtotal producto:</strong> $<span id="subtotalEnvio">0.00</span><br>
                    <strong>Costo env√≠o:</strong> $<span id="costoEnvioMostrar">0.00</span><br>
                    <hr style="border-color: white; opacity: 0.3;">
                    <strong>Total a cobrar:</strong> $<span id="totalEnvio" style="font-size: 1.3em;">0.00</span>
                </div>
                <button type="submit" class="btn btn-secondary">üì¶ Registrar Env√≠o</button>
            </form>
        </div>
    </div>

    <!-- Modal: Inventario -->
    <div id="inventarioModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="cerrarModal('inventarioModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üì¶ Inventario Completo</h2>
            <div id="inventarioContent"></div>
        </div>
    </div>

    <!-- Modal: Reportes -->
    <div id="reportesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="cerrarModal('reportesModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üìä Reportes de Ventas</h2>
            <div id="reportesContent" style="max-height: 70vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Modal: Cancelar Venta -->
    <div id="cancelarVentaModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="cerrarModal('cancelarVentaModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">‚ùå Cancelar Venta</h2>
            <div id="listadoVentasContent" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Modal: Tendencias -->
    <div id="tendenciasModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="cerrarModal('tendenciasModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üìà Tendencias de Ventas</h2>
            <div id="tendenciasContent" style="max-height: 80vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Modal: Nueva Recepci√≥n de Mercanc√≠a -->
    <div id="nuevaRecepcionModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="cerrarModal('nuevaRecepcionModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üì¶ Registrar Recepci√≥n de Mercanc√≠a</h2>
            
            <form onsubmit="registrarRecepcion(event)">
                <div class="input-group">
                    <label>Origen/Remitente</label>
                    <input type="text" id="origenRecepcion" required placeholder="Ej: Puebla - F√°brica" value="Puebla">
                </div>
                
                <div class="input-group">
                    <label>N√∫mero de gu√≠a o referencia</label>
                    <input type="text" id="guiaRecepcion" placeholder="N√∫mero de env√≠o o gu√≠a">
                </div>
                
                <div class="input-group">
                    <label>Fecha de recepci√≥n</label>
                    <input type="datetime-local" id="fechaRecepcion" required>
                </div>
                
                <!-- Agregar productos recibidos -->
                <div style="background: linear-gradient(135deg, #f0f0f0, #e0e0e0); padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <h3 style="margin: 0 0 15px 0; color: var(--dark);">Agregar Producto Recibido</h3>
                    <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 15px; align-items: end;">
                        <div class="input-group" style="margin: 0;">
                            <label>Sabor</label>
                            <select id="saborRecepcion">
                                <option value="">Selecciona</option>
                                <option value="fuego">üî• Fuego</option>
                                <option value="misterio">üåü Misterio</option>
                                <option value="habanero">ü´ë Habanero</option>
                                <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                                <option value="adobadas">üçÖ Adobadas</option>
                                <option value="naturales">üßÇ Naturales</option>
                                <option value="especias">‚ú® Especias</option>
                                <option value="chipotle">üî• Chipotle</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Tama√±o</label>
                            <select id="tama√±oRecepcion">
                                <option value="">Tama√±o</option>
                                <option value="50">50g</option>
                                <option value="100">100g</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin: 0;">
                            <label>Cantidad</label>
                            <input type="number" id="cantidadRecepcion" min="1" placeholder="0">
                        </div>
                        <button type="button" class="btn btn-secondary" style="margin: 0; height: 48px;" onclick="agregarARecepcion()">
                            ‚ûï AGREGAR
                        </button>
                    </div>
                </div>
                
                <!-- Lista de productos a recibir -->
                <h3 style="color: var(--dark); margin-bottom: 15px;">üìã Productos a Recibir</h3>
                <div class="carrito-container">
                    <div id="listaRecepcion">
                        <div class="carrito-vacio">No hay productos agregados</div>
                    </div>
                </div>
                
                <!-- Costo del env√≠o -->
                <div class="input-group">
                    <label>Costo total del env√≠o (opcional)</label>
                    <input type="number" id="costoEnvioRecepcion" step="0.01" min="0" placeholder="0.00" onchange="actualizarCostoUnitario()">
                    <small style="color: #666; display: block; margin-top: 5px;">El costo se distribuir√° entre todos los productos recibidos</small>
                </div>
                
                <!-- Notas -->
                <div class="input-group">
                    <label>Notas adicionales</label>
                    <textarea id="notasRecepcion" rows="3" placeholder="Observaciones sobre el estado de los productos, etc."></textarea>
                </div>
                
                <!-- Resumen de la recepci√≥n -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <div id="resumenRecepcion">
                        <div>Total de productos: <strong id="totalProductosRecepcion">0</strong> unidades</div>
                        <div>Costo por unidad: $<strong id="costoUnitarioRecepcion">0.00</strong></div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success" id="btnConfirmarRecepcion" disabled style="margin-top: 20px;">
                    ‚úÖ CONFIRMAR RECEPCI√ìN
                </button>
            </form>
        </div>
    </div>
    
    <!-- Modal: Ver Recepciones -->
    <div id="recepcionesPendientesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close" onclick="cerrarModal('recepcionesPendientesModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üìã Historial de Recepciones</h2>
            <div id="recepcionesContent" style="max-height: 80vh; overflow-y: auto;"></div>
        </div>
    </div>
    
    <!-- Modal: Flujo de Efectivo -->
    <div id="flujoEfectivoModal" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <span class="close" onclick="cerrarModal('flujoEfectivoModal')">&times;</span>
            <h2 style="color: var(--dark); margin-bottom: 30px;">üí∞ Flujo de Efectivo Hist√≥rico</h2>
            <div id="flujoEfectivoContent" style="max-height: 80vh; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertContainer" style="position: fixed; top: 80px; right: 20px; z-index: 3000;"></div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBA6Wjrf9sbRMcSmE-_If7Ecd_RkybwlgY",
            authDomain: "malanguisimas-992db.firebaseapp.com",
            projectId: "malanguisimas-992db",
            storageBucket: "malanguisimas-992db.firebasestorage.app",
            messagingSenderId: "279815762562",
            appId: "1:279815762562:web:d77520d7a09ac3b36bfa9b",
            measurementId: "G-6ERTR0YGT4"
        };

        // C√≥digo de acceso (cambia esto por tu c√≥digo deseado)
        const CODIGO_ACCESO = "MALCH2025";

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Variables globales
        let usuarioAutenticado = false;
        let carritoVenta = [];
        let tipoVentaActual = 'menudeo';
        let carritoRecepcion = [];
        
        let sistemaData = {
            inventario: {},
            costos_unitarios: {},
            ventas: [],
            regaladas: [],
            gastos: [],
            ajustes: [],
            conversiones: [],
            envios: [],
            recepciones: [],
            sabores: ['fuego', 'misterio', 'habanero', 'jalape√±o', 'adobadas', 'naturales', 'especias', 'chipotle'],
            tama√±os: [50, 100],
            precios_mayoreo: {50: 20.0, 100: 33.0},
            precios_menudeo: {50: 25.0, 100: 40.0},
            precios_compra: {50: 15.0, 100: 23.0}
        };
        
        // Configurar zona horaria de M√©xico
        const timeZone = 'America/Mexico_City';

        // Verificar si hay sesi√≥n activa
        function verificarSesion() {
            const sesionActiva = sessionStorage.getItem('malanguisimas_auth');
            if (sesionActiva === 'true') {
                usuarioAutenticado = true;
                mostrarAplicacion();
                cargarDatosFirebase();
            }
        }

        // Iniciar sesi√≥n
        function iniciarSesion(event) {
            event.preventDefault();
            const codigo = document.getElementById('codigoAcceso').value;
            
            if (codigo === CODIGO_ACCESO) {
                usuarioAutenticado = true;
                sessionStorage.setItem('malanguisimas_auth', 'true');
                document.getElementById('loginError').classList.add('hidden');
                mostrarAplicacion();
                cargarDatosFirebase();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
                // Limpiar el campo
                document.getElementById('codigoAcceso').value = '';
                // Hacer shake al formulario
                document.querySelector('.login-card').style.animation = 'shake 0.5s';
                setTimeout(() => {
                    document.querySelector('.login-card').style.animation = '';
                }, 500);
            }
        }

        // Animaci√≥n de shake
        const shakeAnimation = document.createElement('style');
        shakeAnimation.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
        `;
        document.head.appendChild(shakeAnimation);

        // Cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øEst√°s seguro de que deseas salir del sistema?')) {
                sessionStorage.removeItem('malanguisimas_auth');
                location.reload();
            }
        }

        // Mostrar aplicaci√≥n principal
        function mostrarAplicacion() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('syncStatus').classList.remove('hidden');
        }

        // Cargar datos desde Firebase
        async function cargarDatosFirebase() {
            try {
                actualizarEstadoSync('syncing');
                
                // Cargar inventario
                const inventarioSnap = await db.collection('inventario').get();
                sistemaData.inventario = {};
                inventarioSnap.forEach(doc => {
                    sistemaData.inventario[doc.id] = doc.data().cantidad;
                });

                // Cargar costos
                const costosSnap = await db.collection('costos').get();
                sistemaData.costos_unitarios = {};
                costosSnap.forEach(doc => {
                    sistemaData.costos_unitarios[doc.id] = doc.data().costo;
                });

                // Cargar ventas del d√≠a
                const hoy = obtenerFechaMexico();
                // Cargar ventas (√∫ltimas 100)
                const ventasSnap = await db.collection('ventas')
                    .orderBy('fecha', 'desc')
                    .limit(100)
                    .get();
                sistemaData.ventas = [];
                ventasSnap.forEach(doc => {
                    sistemaData.ventas.push({id: doc.id, ...doc.data()});
                });

                // Cargar regaladas del d√≠a
                const regaladashSnap = await db.collection('regaladas')
                    .orderBy('fecha', 'desc')
                    .limit(50)
                    .get();
                sistemaData.regaladas = [];
                regaladashSnap.forEach(doc => {
                    sistemaData.regaladas.push({id: doc.id, ...doc.data()});
                });

                // Cargar gastos del d√≠a
                const gastosSnap = await db.collection('gastos')
                    .orderBy('fecha', 'desc')
                    .limit(50)
                    .get();
                sistemaData.gastos = [];
                gastosSnap.forEach(doc => {
                    sistemaData.gastos.push({id: doc.id, ...doc.data()});
                });

                // Cargar ajustes del d√≠a
                const ajustesSnap = await db.collection('ajustes')
                    .orderBy('fecha', 'desc')
                    .limit(50)
                    .get();
                sistemaData.ajustes = [];
                ajustesSnap.forEach(doc => {
                    sistemaData.ajustes.push({id: doc.id, ...doc.data()});
                });

                // Cargar conversiones (√∫ltimas 50)
                const conversionesSnap = await db.collection('conversiones')
                    .orderBy('fecha', 'desc')
                    .limit(50)
                    .get();
                sistemaData.conversiones = [];
                conversionesSnap.forEach(doc => {
                    sistemaData.conversiones.push({id: doc.id, ...doc.data()});
                });

                // Cargar env√≠os del d√≠a
                const enviosSnap = await db.collection('envios')
                    .orderBy('fecha', 'desc')
                    .limit(100)
                    .get();
                sistemaData.envios = [];
                enviosSnap.forEach(doc => {
                    sistemaData.envios.push({id: doc.id, ...doc.data()});
                });
                
                // Cargar recepciones
                const recepcionesSnap = await db.collection('recepciones')
                    .orderBy('fecha_recepcion', 'desc')
                    .limit(100)
                    .get();
                sistemaData.recepciones = [];
                recepcionesSnap.forEach(doc => {
                    sistemaData.recepciones.push({id: doc.id, ...doc.data()});
                });

                // Verificar si es necesario inicializar productos
                if (Object.keys(sistemaData.inventario).length === 0) {
                    await crearProductosIniciales();
                }

                actualizarEstadisticas();
                actualizarEstadoSync('online');
                actualizarUltimaSincronizacion();
                
            } catch (error) {
                console.error('Error al cargar datos:', error);
                mostrarAlerta('‚ö†Ô∏è Error al cargar datos. Verifica tu conexi√≥n.', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Crear productos iniciales en Firebase
        async function crearProductosIniciales() {
            const batch = db.batch();
            
            sistemaData.sabores.forEach(sabor => {
                sistemaData.tama√±os.forEach(tama√±o => {
                    const codigo = `${sabor}_${tama√±o}g`;
                    
                    // Crear documento de inventario
                    const invRef = db.collection('inventario').doc(codigo);
                    batch.set(invRef, { cantidad: 0 });
                    
                    // Crear documento de costos
                    const costoRef = db.collection('costos').doc(codigo);
                    batch.set(costoRef, { costo: sistemaData.precios_compra[tama√±o] });
                    
                    sistemaData.inventario[codigo] = 0;
                    sistemaData.costos_unitarios[codigo] = sistemaData.precios_compra[tama√±o];
                });
            });
            
            await batch.commit();
        }

        // Sincronizar datos manualmente
        async function sincronizarDatos() {
            await cargarDatosFirebase();
            mostrarAlerta('‚úÖ Datos sincronizados correctamente', 'success');
        }

        // Actualizar estado de sincronizaci√≥n
        function actualizarEstadoSync(estado) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            syncStatus.classList.remove('offline', 'syncing');
            
            switch(estado) {
                case 'online':
                    syncText.textContent = 'Sincronizado';
                    break;
                case 'offline':
                    syncText.textContent = 'Sin conexi√≥n';
                    syncStatus.classList.add('offline');
                    break;
                case 'syncing':
                    syncText.textContent = 'Sincronizando...';
                    syncStatus.classList.add('syncing');
                    break;
            }
        }

        // Actualizar √∫ltima sincronizaci√≥n
        function actualizarUltimaSincronizacion() {
            const ahora = new Date();
            const hora = ahora.toLocaleTimeString('es-MX', {
                timeZone: timeZone,
                hour: '2-digit', 
                minute:'2-digit'
            });
            document.getElementById('ultimaSinc').textContent = hora;
        }
        
        // Obtener fecha y hora actual en M√©xico
        function obtenerFechaHoraMexico() {
            return new Date().toLocaleString('en-US', { timeZone: timeZone });
        }
        
        // Obtener solo fecha en M√©xico
        function obtenerFechaMexico() {
            const fecha = new Date(obtenerFechaHoraMexico());
            return fecha.toISOString().split('T')[0];
        }

        // Funciones de modal
        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevenir scroll del body
            
            // Establecer fecha actual para recepci√≥n
            if (modalId === 'nuevaRecepcionModal') {
                const ahora = new Date(obtenerFechaHoraMexico());
                const year = ahora.getFullYear();
                const month = String(ahora.getMonth() + 1).padStart(2, '0');
                const day = String(ahora.getDate()).padStart(2, '0');
                const hours = String(ahora.getHours()).padStart(2, '0');
                const minutes = String(ahora.getMinutes()).padStart(2, '0');
                
                const fechaActual = `${year}-${month}-${day}T${hours}:${minutes}`;
                document.getElementById('fechaRecepcion').value = fechaActual;
            }
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            document.body.style.overflow = 'auto'; // Restaurar scroll del body
            
            // Limpiar el campo de stock actual cuando se cierra el modal
            if (modalId === 'quitarStockModal') {
                document.getElementById('stockActualInfo').classList.add('hidden');
                document.getElementById('saborQuitar').value = '';
                document.getElementById('tama√±oQuitar').value = '';
                document.getElementById('cantidadQuitar').value = '';
            } else if (modalId === 'convertirStockModal') {
                document.getElementById('stockConversionInfo').classList.add('hidden');
                document.getElementById('tipoConversion').value = '';
                document.getElementById('saborConvertir').value = '';
                document.getElementById('cantidadConvertir').value = '';
            } else if (modalId === 'cancelarVentaModal') {
                document.getElementById('listadoVentasContent').innerHTML = '';
            } else if (modalId === 'tendenciasModal') {
                document.getElementById('tendenciasContent').innerHTML = '';
            } else if (modalId === 'ventaMultipleModal') {
                limpiarCarrito();
            } else if (modalId === 'nuevaRecepcionModal') {
                limpiarFormularioRecepcion();
            } else if (modalId === 'recepcionesPendientesModal') {
                document.getElementById('recepcionesContent').innerHTML = '';
            } else if (modalId === 'flujoEfectivoModal') {
                document.getElementById('flujoEfectivoContent').innerHTML = '';
            }
        }
        
        function limpiarFormularioRecepcion() {
            carritoRecepcion = [];
            document.getElementById('origenRecepcion').value = 'Puebla';
            document.getElementById('guiaRecepcion').value = '';
            document.getElementById('fechaRecepcion').value = '';
            document.getElementById('saborRecepcion').value = '';
            document.getElementById('tama√±oRecepcion').value = '';
            document.getElementById('cantidadRecepcion').value = '';
            document.getElementById('costoEnvioRecepcion').value = '';
            document.getElementById('notasRecepcion').value = '';
            actualizarVistaRecepcion();
        }
        
        function agregarARecepcion() {
            const sabor = document.getElementById('saborRecepcion').value;
            const tama√±o = parseInt(document.getElementById('tama√±oRecepcion').value);
            const cantidad = parseInt(document.getElementById('cantidadRecepcion').value);
            
            if (!sabor || !tama√±o || !cantidad || cantidad <= 0) {
                mostrarAlerta('‚ùå Completa todos los campos correctamente', 'error');
                return;
            }
            
            const item = {
                codigo: `${sabor}_${tama√±o}g`,
                sabor: sabor,
                tama√±o: tama√±o,
                cantidad: cantidad
            };
            
            carritoRecepcion.push(item);
            actualizarVistaRecepcion();
            
            // Limpiar campos
            document.getElementById('saborRecepcion').value = '';
            document.getElementById('tama√±oRecepcion').value = '';
            document.getElementById('cantidadRecepcion').value = '';
            
            mostrarAlerta('‚úÖ Producto agregado a la recepci√≥n', 'success');
        }
        
        function quitarDeRecepcion(index) {
            carritoRecepcion.splice(index, 1);
            actualizarVistaRecepcion();
        }
        
        function actualizarVistaRecepcion() {
            const listaDiv = document.getElementById('listaRecepcion');
            
            if (carritoRecepcion.length === 0) {
                listaDiv.innerHTML = '<div class="carrito-vacio">No hay productos agregados</div>';
                document.getElementById('btnConfirmarRecepcion').disabled = true;
                actualizarCostoUnitario();
                return;
            }
            
            let html = '';
            carritoRecepcion.forEach((item, index) => {
                const saborTitulo = item.sabor.charAt(0).toUpperCase() + item.sabor.slice(1);
                html += `
                    <div class="carrito-item">
                        <div>
                            <strong>${saborTitulo} ${item.tama√±o}g</strong> x${item.cantidad}
                        </div>
                        <button type="button" class="btn-inline" onclick="quitarDeRecepcion(${index})">‚ùå</button>
                    </div>
                `;
            });
            
            listaDiv.innerHTML = html;
            document.getElementById('btnConfirmarRecepcion').disabled = false;
            actualizarCostoUnitario();
        }
        
        function actualizarCostoUnitario() {
            let totalProductos = 0;
            carritoRecepcion.forEach(item => {
                totalProductos += item.cantidad;
            });
            
            const costoEnvio = parseFloat(document.getElementById('costoEnvioRecepcion').value) || 0;
            const costoUnitario = totalProductos > 0 ? (costoEnvio / totalProductos) : 0;
            
            document.getElementById('totalProductosRecepcion').textContent = totalProductos;
            document.getElementById('costoUnitarioRecepcion').textContent = costoUnitario.toFixed(2);
        }
        
        async function registrarRecepcion(event) {
            event.preventDefault();
            
            if (carritoRecepcion.length === 0) {
                mostrarAlerta('‚ùå Agrega al menos un producto a la recepci√≥n', 'error');
                return;
            }
            
            const origen = document.getElementById('origenRecepcion').value;
            const guia = document.getElementById('guiaRecepcion').value;
            const fechaRecepcion = document.getElementById('fechaRecepcion').value;
            const costoEnvio = parseFloat(document.getElementById('costoEnvioRecepcion').value) || 0;
            const notas = document.getElementById('notasRecepcion').value;
            
            let totalProductos = 0;
            const productos = carritoRecepcion.map(item => {
                totalProductos += item.cantidad;
                return {
                    codigo: item.codigo,
                    sabor: item.sabor,
                    tama√±o: item.tama√±o,
                    cantidad: item.cantidad
                };
            });
            
            const costoUnitario = totalProductos > 0 ? (costoEnvio / totalProductos) : 0;
            
            try {
                actualizarEstadoSync('syncing');
                
                const recepcion = {
                    fecha_recepcion: new Date(fechaRecepcion).toISOString(),
                    fecha_registro: new Date().toISOString(),
                    origen: origen,
                    guia: guia,
                    productos: productos,
                    total_productos: totalProductos,
                    costo_envio: costoEnvio,
                    costo_unitario: costoUnitario,
                    notas: notas,
                    estado: 'recibido'
                };
                
                const docRef = await db.collection('recepciones').add(recepcion);
                recepcion.id = docRef.id;
                
                // Actualizar inventario para cada producto recibido
                const batch = db.batch();
                for (const producto of productos) {
                    const stockActual = sistemaData.inventario[producto.codigo] || 0;
                    const invRef = db.collection('inventario').doc(producto.codigo);
                    batch.set(invRef, { cantidad: stockActual + producto.cantidad });
                    
                    // Actualizar localmente
                    sistemaData.inventario[producto.codigo] = stockActual + producto.cantidad;
                    
                    // Si hay costo de env√≠o, actualizar el costo unitario del producto
                    if (costoUnitario > 0) {
                        const costoActual = sistemaData.costos_unitarios[producto.codigo] || 0;
                        const nuevoPromedio = (costoActual + costoUnitario) / 2; // Promedio simple por ahora
                        
                        const costoRef = db.collection('costos').doc(producto.codigo);
                        batch.set(costoRef, { costo: nuevoPromedio });
                        
                        sistemaData.costos_unitarios[producto.codigo] = nuevoPromedio;
                    }
                }
                await batch.commit();
                
                sistemaData.recepciones.push(recepcion);
                
                mostrarAlerta(`‚úÖ Recepci√≥n registrada<br>Origen: ${origen}<br>Total productos: ${totalProductos}<br>Inventario actualizado`, 'success');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('nuevaRecepcionModal');
                
            } catch (error) {
                console.error('Error al registrar recepci√≥n:', error);
                mostrarAlerta('‚ùå Error al registrar recepci√≥n', 'error');
                actualizarEstadoSync('offline');
            }
        }
        
        async function mostrarRecepcionesPendientes() {
            const recepcionesOrdenadas = sistemaData.recepciones.sort((a, b) => 
                new Date(b.fecha_recepcion) - new Date(a.fecha_recepcion)
            );
            
            let html = '<div style="margin-bottom: 20px;">';
            
            if (recepcionesOrdenadas.length === 0) {
                html += '<p style="text-align: center; color: #666; font-size: 1.1em;">No hay recepciones registradas.</p>';
            } else {
                // Recepciones por mes
                const recepcionesPorMes = {};
                recepcionesOrdenadas.forEach(recepcion => {
                    const fecha = new Date(recepcion.fecha_recepcion);
                    const mesA√±o = fecha.toLocaleDateString('es-MX', { year: 'numeric', month: 'long' });
                    
                    if (!recepcionesPorMes[mesA√±o]) {
                        recepcionesPorMes[mesA√±o] = [];
                    }
                    recepcionesPorMes[mesA√±o].push(recepcion);
                });
                
                Object.entries(recepcionesPorMes).forEach(([mes, recepciones]) => {
                    html += `<h3 style="margin-top: 30px; color: var(--dark);">üìÖ ${mes}</h3>`;
                    
                    recepciones.forEach(recepcion => {
                        const fechaRecepcion = new Date(recepcion.fecha_recepcion);
                        const fechaStr = fechaRecepcion.toLocaleDateString('es-MX', {
                            timeZone: timeZone,
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const resumenProductos = recepcion.productos.map(p => 
                            `${p.sabor} ${p.tama√±o}g x${p.cantidad}`
                        ).join(', ');
                        
                        html += `
                            <div style="background: linear-gradient(135deg, #e8f5e9, #c8e6c9); padding: 25px; margin: 20px 0; 
                                        border-radius: 20px; border-left: 6px solid var(--success);
                                        box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: var(--transition);"
                                 onmouseover="this.style.transform='translateX(10px)'"
                                 onmouseout="this.style.transform='translateX(0)'">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 15px 0; color: var(--dark); font-size: 1.3em;">
                                            üì¶ ${recepcion.origen}
                                        </h4>
                                        ${recepcion.guia ? `<p style="margin: 8px 0; color: #666;">üìÑ <strong>Gu√≠a:</strong> ${recepcion.guia}</p>` : ''}
                                        <p style="margin: 8px 0; color: #666;"><strong>üìÖ Fecha:</strong> ${fechaStr}</p>
                                        <p style="margin: 8px 0; color: #666;"><strong>üì¶ Productos:</strong> ${resumenProductos}</p>
                                        ${recepcion.notas ? `<p style="margin: 8px 0; color: #666;"><strong>üìù Notas:</strong> ${recepcion.notas}</p>` : ''}
                                        <div style="margin-top: 15px; display: flex; gap: 15px; flex-wrap: wrap;">
                                            <span style="background: #fff3cd; color: #856404; padding: 8px 16px; 
                                                       border-radius: 50px; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                                üì¶ Total: ${recepcion.total_productos} productos
                                            </span>
                                            ${recepcion.costo_envio > 0 ? `
                                                <span style="background: #cce5ff; color: #004085; padding: 8px 16px; 
                                                           border-radius: 50px; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                                                    üí∞ Costo env√≠o: $${recepcion.costo_envio.toFixed(2)}
                                                </span>
                                            ` : ''}
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="background: linear-gradient(135deg, var(--success), #229954); 
                                                   color: white; padding: 10px 20px; border-radius: 50px; 
                                                   font-weight: 600; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                                            ‚úÖ Recibido
                                        </span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                });
            }
            
            html += '</div>';
            document.getElementById('recepcionesContent').innerHTML = html;
            mostrarModal('recepcionesPendientesModal');
        }
        
        // Funci√≥n para mostrar flujo de efectivo
        async function mostrarFlujoEfectivo() {
            // Obtener datos hist√≥ricos
            let movimientos = [];
            
            // Agregar ventas
            sistemaData.ventas.forEach(venta => {
                movimientos.push({
                    fecha: venta.fecha,
                    tipo: 'ingreso',
                    concepto: venta.es_pedido ? `Venta (Pedido ${venta.cliente})` : 'Venta',
                    detalle: venta.productos ? 
                        venta.productos.map(p => `${p.sabor} ${p.tama√±o}g x${p.cantidad}`).join(', ') :
                        `${venta.producto} x${venta.cantidad}`,
                    monto: venta.total_venta,
                    categoria: 'venta'
                });
            });
            
            // Agregar env√≠os
            sistemaData.envios.forEach(envio => {
                movimientos.push({
                    fecha: envio.fecha,
                    tipo: 'ingreso',
                    concepto: `Env√≠o a ${envio.cliente}`,
                    detalle: `${envio.producto} x${envio.cantidad}`,
                    monto: envio.total_venta,
                    categoria: 'envio'
                });
            });
            
            // Agregar gastos
            sistemaData.gastos.forEach(gasto => {
                movimientos.push({
                    fecha: gasto.fecha,
                    tipo: 'egreso',
                    concepto: gasto.concepto,
                    detalle: gasto.categoria,
                    monto: gasto.monto,
                    categoria: 'gasto'
                });
            });
            
            // Agregar recepciones como egresos (costo de env√≠o)
            sistemaData.recepciones.forEach(recepcion => {
                if (recepcion.costo_envio > 0) {
                    movimientos.push({
                        fecha: recepcion.fecha_recepcion,
                        tipo: 'egreso',
                        concepto: `Recepci√≥n de ${recepcion.origen}`,
                        detalle: `${recepcion.total_productos} productos${recepcion.guia ? ' - Gu√≠a: ' + recepcion.guia : ''}`,
                        monto: recepcion.costo_envio,
                        categoria: 'recepcion'
                    });
                }
            });
            
            // Ordenar por fecha
            movimientos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Calcular totales y balance
            let totalIngresos = 0;
            let totalEgresos = 0;
            let balanceAcumulado = 0;
            
            // Invertir para calcular balance acumulado correctamente
            const movimientosInvertidos = [...movimientos].reverse();
            movimientosInvertidos.forEach(mov => {
                if (mov.tipo === 'ingreso') {
                    totalIngresos += mov.monto;
                    balanceAcumulado += mov.monto;
                } else {
                    totalEgresos += mov.monto;
                    balanceAcumulado -= mov.monto;
                }
                mov.balance = balanceAcumulado;
            });
            
            const balanceActual = totalIngresos - totalEgresos;
            
            let html = `
                <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; 
                            padding: 35px; border-radius: 25px; margin-bottom: 30px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h3 style="margin: 0 0 25px 0; font-size: 1.5em;">üí∞ Resumen de Efectivo</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px;">
                        <div style="text-align: center;">
                            <div style="font-size: 3em; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                $${totalIngresos.toFixed(2)}
                            </div>
                            <div style="font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">
                                Total Ingresos
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 3em; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                $${totalEgresos.toFixed(2)}
                            </div>
                            <div style="font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">
                                Total Gastos
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 3em; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
                                        color: ${balanceActual >= 0 ? '#fff' : '#ffcccc'};">
                                $${balanceActual.toFixed(2)}
                            </div>
                            <div style="font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9;">
                                Balance Actual
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Filtros
            html += `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 25px;">
                    <label style="margin-right: 20px; font-weight: 600;">
                        <strong>Filtrar por per√≠odo:</strong>
                        <select id="filtroFlujo" onchange="filtrarFlujoEfectivo()" 
                                style="margin-left: 10px; padding: 8px 15px; border-radius: 10px; border: 2px solid #ddd;">
                            <option value="todos">Todos</option>
                            <option value="hoy">Hoy</option>
                            <option value="semana">Esta semana</option>
                            <option value="mes">Este mes</option>
                            <option value="mes3">√öltimos 3 meses</option>
                        </select>
                    </label>
                </div>
            `;
            
            // Tabla de movimientos
            html += `
                <div id="tablaMovimientos">
                    <h4 style="margin-bottom: 20px; color: var(--dark);">üìã Historial de Movimientos</h4>
                    <div style="overflow-x: auto; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Concepto</th>
                                    <th>Detalle</th>
                                    <th style="text-align: right;">Ingreso</th>
                                    <th style="text-align: right;">Egreso</th>
                                    <th style="text-align: right;">Balance</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            movimientos.forEach(mov => {
                const fecha = new Date(mov.fecha);
                const fechaStr = fecha.toLocaleDateString('es-MX', {
                    timeZone: timeZone,
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const esIngreso = mov.tipo === 'ingreso';
                const colorFila = esIngreso ? '#e8f5e8' : '#ffe0e0';
                
                html += `
                    <tr style="background: ${colorFila};" class="fila-movimiento" data-fecha="${mov.fecha}">
                        <td>${fechaStr}</td>
                        <td style="font-weight: 600;">${mov.concepto}</td>
                        <td style="font-size: 0.9em; color: #666;">${mov.detalle}</td>
                        <td style="text-align: right; color: var(--success); font-weight: 700;">
                            ${esIngreso ? `$${mov.monto.toFixed(2)}` : '-'}
                        </td>
                        <td style="text-align: right; color: var(--danger); font-weight: 700;">
                            ${!esIngreso ? `$${mov.monto.toFixed(2)}` : '-'}
                        </td>
                        <td style="text-align: right; font-weight: 800; 
                                   color: ${mov.balance >= 0 ? 'var(--success)' : 'var(--danger)'};">
                            $${mov.balance.toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Guardar movimientos para filtrado
            window.movimientosFlujo = movimientos;
            
            document.getElementById('flujoEfectivoContent').innerHTML = html;
            mostrarModal('flujoEfectivoModal');
        }
        
        // Funci√≥n para filtrar flujo de efectivo
        function filtrarFlujoEfectivo() {
            const filtro = document.getElementById('filtroFlujo').value;
            const filas = document.querySelectorAll('.fila-movimiento');
            const hoy = new Date();
            
            let fechaLimite;
            
            switch(filtro) {
                case 'hoy':
                    fechaLimite = new Date(hoy);
                    fechaLimite.setHours(0, 0, 0, 0);
                    break;
                case 'semana':
                    fechaLimite = new Date(hoy);
                    fechaLimite.setDate(hoy.getDate() - 7);
                    break;
                case 'mes':
                    fechaLimite = new Date(hoy);
                    fechaLimite.setMonth(hoy.getMonth() - 1);
                    break;
                case 'mes3':
                    fechaLimite = new Date(hoy);
                    fechaLimite.setMonth(hoy.getMonth() - 3);
                    break;
                default:
                    fechaLimite = new Date(0); // Mostrar todos
            }
            
            filas.forEach(fila => {
                const fechaMovimiento = new Date(fila.dataset.fecha);
                if (fechaMovimiento >= fechaLimite) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        }

        // Mostrar stock actual
        function mostrarStockActual() {
            const sabor = document.getElementById('saborQuitar').value;
            const tama√±o = document.getElementById('tama√±oQuitar').value;
            
            if (sabor && tama√±o) {
                const codigo = `${sabor}_${tama√±o}g`;
                const stockActual = sistemaData.inventario[codigo] || 0;
                
                document.getElementById('stockActualTexto').textContent = stockActual;
                document.getElementById('stockActualInfo').classList.remove('hidden');
                
                // Actualizar el m√°ximo de cantidad a quitar
                document.getElementById('cantidadQuitar').max = stockActual;
            } else {
                document.getElementById('stockActualInfo').classList.add('hidden');
            }
        }

        // Agregar stock
        async function agregarStock(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborStock').value;
            const tama√±o = parseInt(document.getElementById('tama√±oStock').value);
            const cantidad = parseInt(document.getElementById('cantidadStock').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            
            try {
                actualizarEstadoSync('syncing');
                
                // Actualizar en Firebase
                const invRef = db.collection('inventario').doc(codigo);
                const doc = await invRef.get();
                const stockActual = doc.exists ? doc.data().cantidad : 0;
                
                await invRef.set({
                    cantidad: stockActual + cantidad
                });
                
                // Actualizar localmente
                sistemaData.inventario[codigo] = stockActual + cantidad;
                
                mostrarAlerta(`‚úÖ Agregadas ${cantidad} unidades de ${sabor} ${tama√±o}g`, 'success');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('agregarStockModal');
                
                // Limpiar formulario
                document.getElementById('saborStock').value = '';
                document.getElementById('tama√±oStock').value = '';
                document.getElementById('cantidadStock').value = '';
                
            } catch (error) {
                console.error('Error al agregar stock:', error);
                mostrarAlerta('‚ùå Error al agregar stock', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Quitar stock
        async function quitarStock(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborQuitar').value;
            const tama√±o = parseInt(document.getElementById('tama√±oQuitar').value);
            const cantidad = parseInt(document.getElementById('cantidadQuitar').value);
            const motivo = document.getElementById('motivoQuitar').value;
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                mostrarAlerta(`‚ùå No puedes quitar m√°s de lo que hay en stock! Stock actual: ${stockActual}`, 'error');
                return;
            }
            
            try {
                actualizarEstadoSync('syncing');
                
                // Crear registro de ajuste
                const ajuste = {
                    fecha: new Date().toISOString(),
                    producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} ${tama√±o}g`,
                    codigo: codigo,
                    cantidad: -cantidad,
                    motivo: motivo,
                    tipo: 'reduccion'
                };
                
                await db.collection('ajustes').add(ajuste);
                
                // Actualizar inventario en Firebase
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                // Actualizar localmente
                sistemaData.ajustes.push(ajuste);
                sistemaData.inventario[codigo] = stockActual - cantidad;
                
                mostrarAlerta(`‚ùå Quitadas ${cantidad} unidades de ${sabor} ${tama√±o}g<br>Motivo: ${motivo}`, 'warning');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('quitarStockModal');
                
            } catch (error) {
                console.error('Error al quitar stock:', error);
                mostrarAlerta('‚ùå Error al quitar stock', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Mostrar inventario
        function mostrarInventario() {
            let html = '<div class="inventory-grid">';
            
            // Ordenar por sabor y tama√±o
            const inventarioOrdenado = Object.entries(sistemaData.inventario).sort((a, b) => {
                const [saborA, tama√±oA] = a[0].split('_');
                const [saborB, tama√±oB] = b[0].split('_');
                if (saborA === saborB) {
                    return parseInt(tama√±oA) - parseInt(tama√±oB);
                }
                return saborA.localeCompare(saborB);
            });
            
            inventarioOrdenado.forEach(([codigo, stock]) => {
                const [sabor, tama√±oStr] = codigo.split('_');
                const tama√±o = parseInt(tama√±oStr);
                const saborTitulo = sabor.charAt(0).toUpperCase() + sabor.slice(1);
                
                let estadoClass, estadoTexto;
                if (stock > 10) {
                    estadoClass = 'stock-good';
                    estadoTexto = 'En Stock';
                } else if (stock > 0) {
                    estadoClass = 'stock-low';
                    estadoTexto = 'Stock Bajo';
                } else {
                    estadoClass = 'stock-out';
                    estadoTexto = 'Agotado';
                }
                
                const costo = sistemaData.costos_unitarios[codigo] || 0;
                const precioMayoreo = sistemaData.precios_mayoreo[tama√±o];
                const precioMenudeo = sistemaData.precios_menudeo[tama√±o];
                
                const margenMayoreo = ((precioMayoreo - costo) / precioMayoreo * 100).toFixed(1);
                const margenMenudeo = ((precioMenudeo - costo) / precioMenudeo * 100).toFixed(1);
                
                mostrarAlerta(`‚úÖ Costo base actualizado: ${costo.toFixed(2)}<br>Margen Mayoreo: ${margenMayoreo}% | Margen Menudeo: ${margenMenudeo}%`, 'success');
                
                actualizarEstadoSync('online');
                cerrarModal('actualizarCostosModal');
                
                // Limpiar formulario
                document.getElementById('saborCosto').value = '';
                document.getElementById('tama√±oCosto').value = '';
                document.getElementById('costoProduccion').value = '';
                
            } catch (error) {
                console.error('Error al actualizar costo:', error);
                mostrarAlerta('‚ùå Error al actualizar costo', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Funciones para venta m√∫ltiple
        function prepararVentaMultiple(tipo) {
            tipoVentaActual = tipo;
            carritoVenta = [];
            
            const titulo = tipo === 'menudeo' ? 'üõí Venta Menudeo' : 'üè™ Venta Mayoreo';
            document.getElementById('tituloVentaMultiple').textContent = titulo;
            
            limpiarCarrito();
            mostrarModal('ventaMultipleModal');
        }
        
        function limpiarCarrito() {
            carritoVenta = [];
            actualizarVistaCarrito();
            document.getElementById('saborVentaMultiple').value = '';
            document.getElementById('tama√±oVentaMultiple').value = '';
            document.getElementById('cantidadVentaMultiple').value = '';
            document.getElementById('costoPersonalizado').checked = false;
            document.getElementById('costoTotalPedido').value = '';
            document.getElementById('costoPersonalizadoContainer').classList.add('hidden');
        }
        
        function agregarAlCarrito() {
            const sabor = document.getElementById('saborVentaMultiple').value;
            const tama√±o = parseInt(document.getElementById('tama√±oVentaMultiple').value);
            const cantidad = parseInt(document.getElementById('cantidadVentaMultiple').value);
            
            if (!sabor || !tama√±o || !cantidad || cantidad <= 0) {
                mostrarAlerta('‚ùå Completa todos los campos correctamente', 'error');
                return;
            }
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            // Verificar stock disponible considerando lo que ya est√° en el carrito
            const enCarrito = carritoVenta
                .filter(item => item.codigo === codigo)
                .reduce((sum, item) => sum + item.cantidad, 0);
            
            if (stockActual < (cantidad + enCarrito)) {
                mostrarAlerta(`‚ùå Stock insuficiente! Disponible: ${stockActual - enCarrito}`, 'error');
                return;
            }
            
            const precioUnitario = tipoVentaActual === 'menudeo' ? 
                sistemaData.precios_menudeo[tama√±o] : 
                sistemaData.precios_mayoreo[tama√±o];
            
            const item = {
                codigo: codigo,
                sabor: sabor,
                tama√±o: tama√±o,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                costoUnitario: sistemaData.costos_unitarios[codigo] || 0,
                subtotal: precioUnitario * cantidad
            };
            
            carritoVenta.push(item);
            actualizarVistaCarrito();
            
            // Limpiar campos
            document.getElementById('saborVentaMultiple').value = '';
            document.getElementById('tama√±oVentaMultiple').value = '';
            document.getElementById('cantidadVentaMultiple').value = '';
            
            mostrarAlerta('‚úÖ Producto agregado al carrito', 'success');
        }
        
        function quitarDelCarrito(index) {
            carritoVenta.splice(index, 1);
            actualizarVistaCarrito();
        }
        
        function actualizarVistaCarrito() {
            const carritoDiv = document.getElementById('carritoVenta');
            
            if (carritoVenta.length === 0) {
                carritoDiv.innerHTML = '<div class="carrito-vacio">El carrito est√° vac√≠o</div>';
                document.getElementById('btnConfirmarVenta').disabled = true;
                actualizarTotalesCarrito();
                return;
            }
            
            let html = '';
            carritoVenta.forEach((item, index) => {
                const saborTitulo = item.sabor.charAt(0).toUpperCase() + item.sabor.slice(1);
                html += `
                    <div class="carrito-item">
                        <div>
                            <strong>${saborTitulo} ${item.tama√±o}g</strong> x${item.cantidad}
                            <br><small style="color: #666;">${item.precioUnitario.toFixed(2)} c/u = ${item.subtotal.toFixed(2)}</small>
                        </div>
                        <button type="button" class="btn-inline" onclick="quitarDelCarrito(${index})">‚ùå</button>
                    </div>
                `;
            });
            
            carritoDiv.innerHTML = html;
            document.getElementById('btnConfirmarVenta').disabled = false;
            actualizarTotalesCarrito();
        }
        
        function toggleCostoPersonalizado() {
            const checkbox = document.getElementById('costoPersonalizado');
            const container = document.getElementById('costoPersonalizadoContainer');
            
            if (checkbox.checked) {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
                document.getElementById('costoTotalPedido').value = '';
            }
            
            actualizarTotalesCarrito();
        }
        
        function actualizarTotalesCarrito() {
            let subtotal = 0;
            let costoTotal = 0;
            
            carritoVenta.forEach(item => {
                subtotal += item.subtotal;
                costoTotal += item.costoUnitario * item.cantidad;
            });
            
            // Si hay costo personalizado, usarlo
            if (document.getElementById('costoPersonalizado').checked) {
                const costoPersonalizado = parseFloat(document.getElementById('costoTotalPedido').value) || 0;
                if (costoPersonalizado > 0) {
                    costoTotal = costoPersonalizado;
                }
            }
            
            const ganancia = subtotal - costoTotal;
            
            document.getElementById('subtotalVenta').textContent = subtotal.toFixed(2);
            document.getElementById('costoVenta').textContent = costoTotal.toFixed(2);
            document.getElementById('gananciaVenta').textContent = ganancia.toFixed(2);
            document.getElementById('totalVenta').textContent = subtotal.toFixed(2);
        }
        
        async function confirmarVentaMultiple() {
            if (carritoVenta.length === 0) {
                mostrarAlerta('‚ùå El carrito est√° vac√≠o', 'error');
                return;
            }
            
            // Verificar stock final
            for (const item of carritoVenta) {
                const stockActual = sistemaData.inventario[item.codigo] || 0;
                if (stockActual < item.cantidad) {
                    mostrarAlerta(`‚ùå Stock insuficiente para ${item.sabor} ${item.tama√±o}g`, 'error');
                    return;
                }
            }
            
            try {
                actualizarEstadoSync('syncing');
                
                // Calcular totales
                let totalVenta = 0;
                let costoTotal = 0;
                
                carritoVenta.forEach(item => {
                    totalVenta += item.subtotal;
                    costoTotal += item.costoUnitario * item.cantidad;
                });
                
                // Si hay costo personalizado, usarlo
                if (document.getElementById('costoPersonalizado').checked) {
                    const costoPersonalizado = parseFloat(document.getElementById('costoTotalPedido').value) || 0;
                    if (costoPersonalizado > 0) {
                        costoTotal = costoPersonalizado;
                    }
                }
                
                const ganancia = totalVenta - costoTotal;
                
                // Crear detalle de productos
                const productos = carritoVenta.map(item => ({
                    codigo: item.codigo,
                    sabor: item.sabor,
                    tama√±o: item.tama√±o,
                    cantidad: item.cantidad,
                    precio_unitario: item.precioUnitario,
                    subtotal: item.subtotal
                }));
                
                // Crear venta en Firebase
                const venta = {
                    fecha: new Date().toISOString(),
                    tipo_venta: tipoVentaActual,
                    productos: productos,
                    total_venta: totalVenta,
                    costo_total: costoTotal,
                    costo_personalizado: document.getElementById('costoPersonalizado').checked,
                    ganancia: ganancia,
                    cantidad_total: carritoVenta.reduce((sum, item) => sum + item.cantidad, 0)
                };
                
                await db.collection('ventas').add(venta);
                
                // Actualizar inventario para cada producto
                const batch = db.batch();
                for (const item of carritoVenta) {
                    const stockActual = sistemaData.inventario[item.codigo];
                    const invRef = db.collection('inventario').doc(item.codigo);
                    batch.set(invRef, { cantidad: stockActual - item.cantidad });
                    
                    // Actualizar localmente
                    sistemaData.inventario[item.codigo] = stockActual - item.cantidad;
                }
                await batch.commit();
                
                // Actualizar datos locales
                sistemaData.ventas.push(venta);
                
                // Crear resumen de productos para mostrar
                const resumenProductos = carritoVenta.map(item => 
                    `${item.sabor} ${item.tama√±o}g x${item.cantidad}`
                ).join(', ');
                
                mostrarAlerta(`‚úÖ Venta registrada<br>Productos: ${resumenProductos}<br>Total: ${totalVenta.toFixed(2)}<br>Ganancia: ${ganancia.toFixed(2)}`, 'success');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('ventaMultipleModal');
                
            } catch (error) {
                console.error('Error al registrar venta:', error);
                mostrarAlerta('‚ùå Error al registrar venta', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Registrar gasto
        async function registrarGasto(event) {
            event.preventDefault();
            
            const concepto = document.getElementById('conceptoGasto').value;
            const monto = parseFloat(document.getElementById('montoGasto').value);
            const categoria = document.getElementById('categoriaGasto').value;
            
            try {
                actualizarEstadoSync('syncing');
                
                const gasto = {
                    fecha: new Date().toISOString(),
                    concepto: concepto,
                    monto: monto,
                    categoria: categoria
                };
                
                await db.collection('gastos').add(gasto);
                
                sistemaData.gastos.push(gasto);
                
                mostrarAlerta(`‚úÖ Gasto registrado: ${concepto} - ${monto.toFixed(2)}`, 'success');
                
                actualizarEstadoSync('online');
                cerrarModal('gastosModal');
                
                // Limpiar formulario
                document.getElementById('conceptoGasto').value = '';
                document.getElementById('montoGasto').value = '';
                document.getElementById('categoriaGasto').value = 'operativo';
                
            } catch (error) {
                console.error('Error al registrar gasto:', error);
                mostrarAlerta('‚ùå Error al registrar gasto', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Registrar regalada
        async function registrarRegalada(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborRegalada').value;
            const tama√±o = parseInt(document.getElementById('tama√±oRegalada').value);
            const cantidad = parseInt(document.getElementById('cantidadRegalada').value);
            const puntoVenta = document.getElementById('puntoVenta').value;
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                mostrarAlerta(`‚ùå Stock insuficiente! Disponible: ${stockActual}`, 'error');
                return;
            }
            
            try {
                actualizarEstadoSync('syncing');
                
                const costoUnitario = sistemaData.costos_unitarios[codigo] || 0;
                const costoTotal = costoUnitario * cantidad;
                
                const regalada = {
                    fecha: new Date().toISOString(),
                    producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} ${tama√±o}g`,
                    codigo: codigo,
                    cantidad: cantidad,
                    punto_venta: puntoVenta,
                    costo_total: costoTotal
                };
                
                await db.collection('regaladas').add(regalada);
                
                // Actualizar inventario
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                sistemaData.regaladas.push(regalada);
                sistemaData.inventario[codigo] = stockActual - cantidad;
                
                mostrarAlerta(`üéÅ Regalada registrada: ${cantidad}x ${sabor} ${tama√±o}g`, 'warning');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('regaladaModal');
                
                // Limpiar formulario
                document.getElementById('saborRegalada').value = '';
                document.getElementById('tama√±oRegalada').value = '';
                document.getElementById('cantidadRegalada').value = '';
                document.getElementById('puntoVenta').value = '';
                
            } catch (error) {
                console.error('Error al registrar regalada:', error);
                mostrarAlerta('‚ùå Error al registrar regalada', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Mostrar reportes
        function mostrarReportes() {
            const hoy = obtenerFechaMexico();
            const ventasHoy = sistemaData.ventas.filter(venta => venta.fecha.split('T')[0] === hoy);
            const regaladashHoy = sistemaData.regaladas.filter(regalada => regalada.fecha.split('T')[0] === hoy);
            const ajustesHoy = sistemaData.ajustes.filter(ajuste => ajuste.fecha.split('T')[0] === hoy);
            const conversionesHoy = sistemaData.conversiones.filter(conversion => conversion.fecha.split('T')[0] === hoy);
            const enviosHoy = sistemaData.envios.filter(envio => envio.fecha.split('T')[0] === hoy);
            const recepcionesHoy = sistemaData.recepciones.filter(recepcion => recepcion.fecha_recepcion.split('T')[0] === hoy);
            
            let html = '<h3 style="color: var(--dark); margin-bottom: 25px;">üìä Resumen del D√≠a</h3>';
            
            if (ventasHoy.length === 0 && regaladashHoy.length === 0 && ajustesHoy.length === 0 && 
                conversionesHoy.length === 0 && enviosHoy.length === 0 && recepcionesHoy.length === 0) {
                html += '<p style="text-align: center; color: #666; font-size: 1.1em;">No hay actividad registrada para hoy.</p>';
                document.getElementById('reportesContent').innerHTML = html;
                mostrarModal('reportesModal');
                return;
            }
            
            let totalIngresos = 0;
            let totalCostos = 0;
            let costoRegaladas = 0;
            let gananciaProductos = 0;
            let totalEnvios = 0;
            let totalRecepciones = 0;
            
            // Mostrar ventas
            if (ventasHoy.length > 0) {
                html += '<h4 style="color: var(--dark); margin-top: 25px;">üí∞ Ventas del D√≠a</h4>';
                ventasHoy.forEach(venta => {
                    const tipoEmoji = venta.tipo_venta === 'mayoreo' ? 'üè™' : 'üõí';
                    
                    if (venta.productos && Array.isArray(venta.productos)) {
                        // Venta m√∫ltiple
                        const resumenProductos = venta.productos.map(p => 
                            `${p.sabor} ${p.tama√±o}g x${p.cantidad}`
                        ).join(', ');
                        
                        html += `<div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #e8f5e8, #c8e6c9); 
                                           border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                            ${tipoEmoji} <strong>Venta m√∫ltiple:</strong> ${resumenProductos}
                            <br>Total: <strong>${venta.total_venta.toFixed(2)}</strong>
                            ${venta.costo_personalizado ? '<br><small style="color: #666;">* Costo personalizado aplicado</small>' : ''}
                            <br><small style="color: var(--success);">Ganancia: ${venta.ganancia.toFixed(2)}</small>
                        </div>`;
                    }
                    
                    totalIngresos += venta.total_venta;
                    totalCostos += venta.costo_total;
                    gananciaProductos += venta.ganancia;
                });
            }
            
            // Mostrar env√≠os
            if (enviosHoy.length > 0) {
                html += '<h4 style="color: var(--dark); margin-top: 25px;">üì¶ Env√≠os del D√≠a</h4>';
                enviosHoy.forEach(envio => {
                    html += `<div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #e0f2ff, #b3e5fc); 
                                       border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        üì¶ <strong>Env√≠o a ${envio.cliente}:</strong> ${envio.producto} x${envio.cantidad}
                        <br>Total cobrado: <strong>${envio.total_venta.toFixed(2)}</strong> (incluye env√≠o: ${envio.costo_envio.toFixed(2)})
                    </div>`;
                    totalEnvios += envio.total_venta;
                });
            }
            
            // Mostrar recepciones
            if (recepcionesHoy.length > 0) {
                html += '<h4 style="color: var(--dark); margin-top: 25px;">üì¶ Recepciones del D√≠a</h4>';
                recepcionesHoy.forEach(recepcion => {
                    const resumenProductos = recepcion.productos.map(p => 
                        `${p.sabor} ${p.tama√±o}g x${p.cantidad}`
                    ).join(', ');
                    
                    html += `<div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #f0f8ff, #e1f5fe); 
                                       border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        üì¶ <strong>Recepci√≥n de ${recepcion.origen}:</strong> ${resumenProductos}
                        ${recepcion.guia ? `<br>Gu√≠a: ${recepcion.guia}` : ''}
                        ${recepcion.costo_envio > 0 ? `<br>Costo de env√≠o: ${recepcion.costo_envio.toFixed(2)}` : ''}
                    </div>`;
                    totalRecepciones += recepcion.costo_envio || 0;
                });
            }
            
            // Mostrar regaladas
            if (regaladashHoy.length > 0) {
                html += '<h4 style="color: var(--dark); margin-top: 25px;">üéÅ Regaladas del D√≠a</h4>';
                regaladashHoy.forEach(regalada => {
                    html += `<div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
                                       border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        üéÅ <strong>${regalada.producto}:</strong> ${regalada.cantidad} unidades
                        ${regalada.punto_venta ? `<br>Punto: ${regalada.punto_venta}` : ''}
                        <br><small style="color: #856404;">Costo: ${regalada.costo_total.toFixed(2)}</small>
                    </div>`;
                    costoRegaladas += regalada.costo_total;
                });
            }
            
            // Mostrar ajustes
            if (ajustesHoy.length > 0) {
                html += '<h4 style="color: var(--dark); margin-top: 25px;">üìù Ajustes del D√≠a</h4>';
                ajustesHoy.forEach(ajuste => {
                    const tipoEmoji = ajuste.cantidad > 0 ? '‚ûï' : '‚ûñ';
                    html += `<div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #f8d7da, #f5c6cb); 
                                       border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        ${tipoEmoji} <strong>${ajuste.producto}:</strong> ${Math.abs(ajuste.cantidad)} unidades
                        <br>Motivo: ${ajuste.motivo}
                    </div>`;
                });
            }
            
            // Mostrar conversiones
            if (conversionesHoy.length > 0) {
                html += '<h4 style="color: var(--dark); margin-top: 25px;">üîÑ Conversiones del D√≠a</h4>';
                conversionesHoy.forEach(conversion => {
                    html += `<div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, #e7f3ff, #b3d9ff); 
                                       border-radius: 15px; box-shadow: 0 3px 10px rgba(0,0,0,0.1);">
                        üîÑ <strong>${conversion.sabor}:</strong> ${conversion.cantidad_origen} de ${conversion.tama√±o_origen}g ‚Üí ${conversion.cantidad_destino} de ${conversion.tama√±o_destino}g
                    </div>`;
                });
            }
            
            // Resumen financiero
            const totalIngresosDelDia = totalIngresos + totalEnvios;
            const totalGastosDelDia = totalCostos + costoRegaladas + totalRecepciones;
            const gananciaNetaDia = totalIngresosDelDia - totalGastosDelDia;
            
            html += `
                <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; 
                            padding: 30px; border-radius: 20px; margin-top: 30px;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                    <h4 style="margin: 0 0 20px 0; font-size: 1.3em;">üí∞ Resumen Financiero del D√≠a</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;">${totalIngresosDelDia.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Total Ingresos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: 700;">${totalGastosDelDia.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Total Gastos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: 700; color: ${gananciaNetaDia >= 0 ? '#fff' : '#ffcccc'};">
                                ${gananciaNetaDia.toFixed(2)}
                            </div>
                            <div style="opacity: 0.9;">Ganancia Neta</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('reportesContent').innerHTML = html;
            mostrarModal('reportesModal');
        }

        // Mostrar tendencias
        function mostrarTendencias() {
            // Agrupar ventas por d√≠a
            const ventasPorDia = {};
            const ultimosDias = 30; // Mostrar √∫ltimos 30 d√≠as
            
            // Crear array de fechas de los √∫ltimos 30 d√≠as
            const fechas = [];
            for (let i = ultimosDias - 1; i >= 0; i--) {
                const fecha = new Date();
                fecha.setDate(fecha.getDate() - i);
                const fechaStr = fecha.toISOString().split('T')[0];
                fechas.push(fechaStr);
                ventasPorDia[fechaStr] = {
                    totalVentas: 0,
                    cantidadProductos: 0,
                    ganancia: 0,
                    ventasPorSabor: {}
                };
            }
            
            // Procesar ventas
            sistemaData.ventas.forEach(venta => {
                const fechaVenta = venta.fecha.split('T')[0];
                if (ventasPorDia[fechaVenta]) {
                    ventasPorDia[fechaVenta].totalVentas += venta.total_venta;
                    ventasPorDia[fechaVenta].ganancia += venta.ganancia || 0;
                    
                    if (venta.productos && Array.isArray(venta.productos)) {
                        // Venta m√∫ltiple
                        venta.productos.forEach(producto => {
                            ventasPorDia[fechaVenta].cantidadProductos += producto.cantidad;
                            
                            if (!ventasPorDia[fechaVenta].ventasPorSabor[producto.sabor]) {
                                ventasPorDia[fechaVenta].ventasPorSabor[producto.sabor] = 0;
                            }
                            ventasPorDia[fechaVenta].ventasPorSabor[producto.sabor] += producto.cantidad;
                        });
                    } else {
                        // Venta simple
                        ventasPorDia[fechaVenta].cantidadProductos += venta.cantidad;
                        
                        const sabor = venta.codigo ? venta.codigo.split('_')[0] : 'desconocido';
                        if (!ventasPorDia[fechaVenta].ventasPorSabor[sabor]) {
                            ventasPorDia[fechaVenta].ventasPorSabor[sabor] = 0;
                        }
                        ventasPorDia[fechaVenta].ventasPorSabor[sabor] += venta.cantidad;
                    }
                }
            });
            
            // Calcular promedios y tendencias
            let totalVentasPeriodo = 0;
            let totalProductosPeriodo = 0;
            let totalGananciaPeriodo = 0;
            const ventasPorSaborTotal = {};
            
            fechas.forEach(fecha => {
                totalVentasPeriodo += ventasPorDia[fecha].totalVentas;
                totalProductosPeriodo += ventasPorDia[fecha].cantidadProductos;
                totalGananciaPeriodo += ventasPorDia[fecha].ganancia;
                
                Object.entries(ventasPorDia[fecha].ventasPorSabor).forEach(([sabor, cantidad]) => {
                    if (!ventasPorSaborTotal[sabor]) {
                        ventasPorSaborTotal[sabor] = 0;
                    }
                    ventasPorSaborTotal[sabor] += cantidad;
                });
            });
            
            const promedioVentasDiarias = totalVentasPeriodo / ultimosDias;
            const promedioProductosDiarios = totalProductosPeriodo / ultimosDias;
            const promedioGananciaDiaria = totalGananciaPeriodo / ultimosDias;
            
            // Ordenar sabores por popularidad
            const saboresOrdenados = Object.entries(ventasPorSaborTotal)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5); // Top 5 sabores
            
            let html = `
                <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; 
                            padding: 35px; border-radius: 25px; margin-bottom: 30px;
                            box-shadow: 0 15px 40px rgba(0,0,0,0.25);">
                    <h3 style="margin: 0 0 25px 0; font-size: 1.5em;">üìä Resumen de Tendencias (√öltimos ${ultimosDias} d√≠as)</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 25px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 800;">${promedioVentasDiarias.toFixed(2)}</div>
                            <div style="font-weight: 600; opacity: 0.9;">Promedio de Ventas Diarias</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 800;">${Math.round(promedioProductosDiarios)}</div>
                            <div style="font-weight: 600; opacity: 0.9;">Productos Vendidos por D√≠a</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2.5em; font-weight: 800;">${promedioGananciaDiaria.toFixed(2)}</div>
                            <div style="font-weight: 600; opacity: 0.9;">Ganancia Promedio Diaria</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Top sabores
            html += '<h4 style="color: var(--dark); margin-bottom: 20px;">üå∂Ô∏è Sabores M√°s Vendidos</h4>';
            html += '<div style="margin-bottom: 25px;">';
            saboresOrdenados.forEach(([sabor, cantidad], index) => {
                const porcentaje = (cantidad / totalProductosPeriodo * 100).toFixed(1);
                const saborTitulo = sabor.charAt(0).toUpperCase() + sabor.slice(1);
                const medallas = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                const colores = ['#FFD700', '#C0C0C0', '#CD7F32', '#4a90e2', '#9b59b6'];
                
                html += `
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; margin: 15px 0; 
                                border-radius: 15px; border-left: 6px solid ${colores[index]};
                                box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: var(--transition);"
                         onmouseover="this.style.transform='translateX(10px)'"
                         onmouseout="this.style.transform='translateX(0)'">
                        <strong style="font-size: 1.2em;">${medallas[index]} ${saborTitulo}</strong>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                            <div style="color: #666;">${cantidad} unidades vendidas</div>
                            <div style="background: linear-gradient(135deg, ${colores[index]}, ${colores[index]}dd); 
                                       color: white; padding: 8px 16px; border-radius: 50px; font-weight: 600;">
                                ${porcentaje}%
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Gr√°fico de tendencia diaria (simulado con barras)
            html += '<h4 style="color: var(--dark); margin-bottom: 20px;">üìà Tendencia de Ventas Diarias</h4>';
            html += '<div style="background: #f8f9fa; padding: 25px; border-radius: 15px; overflow-x: auto; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);">';
            
            // Encontrar el valor m√°ximo para escalar
            let maxVenta = 0;
            fechas.forEach(fecha => {
                if (ventasPorDia[fecha].totalVentas > maxVenta) {
                    maxVenta = ventasPorDia[fecha].totalVentas;
                }
            });
            
            // Mostrar √∫ltimos 14 d√≠as para mejor visualizaci√≥n
            const fechasRecientes = fechas.slice(-14);
            html += '<div style="display: flex; align-items: flex-end; gap: 10px; min-height: 200px;">';
            
            fechasRecientes.forEach(fecha => {
                const venta = ventasPorDia[fecha].totalVentas;
                const altura = maxVenta > 0 ? (venta / maxVenta * 150) : 0;
                
                const fechaObj = new Date(fecha + 'T12:00:00');
                const fechaCorta = fechaObj.toLocaleDateString('es-MX', { day: '2-digit', month: 'short' });
                
                html += `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div style="background: linear-gradient(to top, var(--primary), var(--secondary)); 
                                   width: 100%; height: ${altura}px; border-radius: 5px 5px 0 0;
                                   transition: all 0.3s ease; cursor: pointer;"
                             onmouseover="this.style.transform='scaleY(1.1)'"
                             onmouseout="this.style.transform='scaleY(1)'"
                             title="${venta.toFixed(2)}">
                        </div>
                        <div style="font-size: 0.8em; margin-top: 5px; text-align: center;">${fechaCorta}</div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            
            // Recomendaciones basadas en tendencias
            html += `
                <div style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9); padding: 25px; 
                            border-radius: 15px; margin-top: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 20px 0; color: var(--dark);">üí° Recomendaciones Basadas en Tendencias</h4>
            `;
            
            // Analizar d√≠as de la semana
            const ventasPorDiaSemana = {};
            fechas.forEach(fecha => {
                const dia = new Date(fecha + 'T12:00:00').toLocaleDateString('es-MX', { weekday: 'long' });
                if (!ventasPorDiaSemana[dia]) {
                    ventasPorDiaSemana[dia] = { total: 0, count: 0 };
                }
                ventasPorDiaSemana[dia].total += ventasPorDia[fecha].totalVentas;
                ventasPorDiaSemana[dia].count += 1;
            });
            
            let mejorDia = '';
            let mejorPromedio = 0;
            Object.entries(ventasPorDiaSemana).forEach(([dia, datos]) => {
                const promedio = datos.total / datos.count;
                if (promedio > mejorPromedio) {
                    mejorPromedio = promedio;
                    mejorDia = dia;
                }
            });
            
            html += `
                    <ul style="margin: 0; padding-left: 25px; line-height: 2;">
                        <li>Tu mejor d√≠a de ventas es <strong>${mejorDia}</strong> con un promedio de ${mejorPromedio.toFixed(2)}</li>
                        <li>El sabor m√°s popular es <strong>${saboresOrdenados[0] ? saboresOrdenados[0][0].charAt(0).toUpperCase() + saboresOrdenados[0][0].slice(1) : 'N/A'}</strong></li>
                        <li>Considera aumentar el stock de los 3 sabores m√°s vendidos</li>
                        <li>Tu promedio de ${Math.round(promedioProductosDiarios)} productos diarios sugiere mantener un stock m√≠nimo de ${Math.round(promedioProductosDiarios * 3)} unidades</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('tendenciasContent').innerHTML = html;
            mostrarModal('tendenciasModal');
        }

        // Mostrar recomendaciones
        function mostrarRecomendaciones() {
            let html = '<div style="max-width: 1000px; margin: 0 auto;">';
            
            // Analizar rotaci√≥n de inventario
            const analisisPorProducto = {};
            
            // Inicializar an√°lisis
            sistemaData.sabores.forEach(sabor => {
                sistemaData.tama√±os.forEach(tama√±o => {
                    const codigo = `${sabor}_${tama√±o}g`;
                    analisisPorProducto[codigo] = {
                        sabor: sabor,
                        tama√±o: tama√±o,
                        stockActual: sistemaData.inventario[codigo] || 0,
                        ventasUltimaSemana: 0,
                        ventasUltimoMes: 0,
                        diasSinMovimiento: 0
                    };
                });
            });
            
            // Calcular ventas por producto
            const hoy = new Date();
            const hace7Dias = new Date(hoy);
            hace7Dias.setDate(hoy.getDate() - 7);
            const hace30Dias = new Date(hoy);
            hace30Dias.setDate(hoy.getDate() - 30);
            
            sistemaData.ventas.forEach(venta => {
                const fechaVenta = new Date(venta.fecha);
                
                if (venta.productos && Array.isArray(venta.productos)) {
                    // Venta m√∫ltiple
                    venta.productos.forEach(producto => {
                        const codigo = producto.codigo;
                        if (analisisPorProducto[codigo]) {
                            if (fechaVenta >= hace7Dias) {
                                analisisPorProducto[codigo].ventasUltimaSemana += producto.cantidad;
                            }
                            if (fechaVenta >= hace30Dias) {
                                analisisPorProducto[codigo].ventasUltimoMes += producto.cantidad;
                            }
                        }
                    });
                } else if (venta.codigo) {
                    // Venta simple
                    if (analisisPorProducto[venta.codigo]) {
                        if (fechaVenta >= hace7Dias) {
                            analisisPorProducto[venta.codigo].ventasUltimaSemana += venta.cantidad;
                        }
                        if (fechaVenta >= hace30Dias) {
                            analisisPorProducto[venta.codigo].ventasUltimoMes += venta.cantidad;
                        }
                    }
                }
            });
            
            // Calcular recomendaciones
            const recomendaciones = {
                reabastecer: [],
                reducirStock: [],
                sinMovimiento: [],
                buenaRotacion: []
            };
            
            Object.entries(analisisPorProducto).forEach(([codigo, datos]) => {
                const promedioSemanal = datos.ventasUltimaSemana / 7;
                const stockDias = promedioSemanal > 0 ? datos.stockActual / promedioSemanal : 999;
                
                const productoInfo = {
                    nombre: `${datos.sabor.charAt(0).toUpperCase() + datos.sabor.slice(1)} ${datos.tama√±o}g`,
                    stockActual: datos.stockActual,
                    ventasSemana: datos.ventasUltimaSemana,
                    ventasMes: datos.ventasUltimoMes,
                    diasDeStock: Math.round(stockDias)
                };
                
                if (stockDias < 3 && datos.ventasUltimaSemana > 0) {
                    recomendaciones.reabastecer.push(productoInfo);
                } else if (stockDias > 30 && datos.stockActual > 20) {
                    recomendaciones.reducirStock.push(productoInfo);
                } else if (datos.ventasUltimoMes === 0 && datos.stockActual > 0) {
                    recomendaciones.sinMovimiento.push(productoInfo);
                } else if (stockDias >= 3 && stockDias <= 14) {
                    recomendaciones.buenaRotacion.push(productoInfo);
                }
            });
            
            // T√≠tulo con estilo
            html += `
                <div style="text-align: center; margin-bottom: 30px;">
                    <h3 style="color: var(--dark); font-size: 2em; margin-bottom: 10px;">
                        üí° Recomendaciones de Stock Inteligentes
                    </h3>
                    <p style="color: #666;">An√°lisis basado en los √∫ltimos 30 d√≠as de actividad</p>
                </div>
            `;
            
            // Mostrar recomendaciones urgentes
            if (recomendaciones.reabastecer.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #f8d7da, #f5c6cb); padding: 25px; 
                                border-radius: 20px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                        <h4 style="color: #721c24; margin: 0 0 20px 0; font-size: 1.5em;">
                            üö® Reabastecer Urgentemente
                        </h4>
                `;
                recomendaciones.reabastecer.forEach(producto => {
                    html += `
                        <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.9); 
                                    border-radius: 10px; border-left: 5px solid #dc3545;">
                            <strong style="font-size: 1.2em;">${producto.nombre}</strong>
                            <br>Stock actual: <strong>${producto.stockActual}</strong> | 
                            Ventas esta semana: <strong>${producto.ventasSemana}</strong>
                            <br><span style="color: #dc3545; font-weight: 600;">
                                ‚ö†Ô∏è Stock para solo ${producto.diasDeStock} d√≠as
                            </span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Productos con buena rotaci√≥n
            if (recomendaciones.buenaRotacion.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 25px; 
                                border-radius: 20px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                        <h4 style="color: #155724; margin: 0 0 20px 0; font-size: 1.5em;">
                            ‚úÖ Productos con Buena Rotaci√≥n
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                `;
                recomendaciones.buenaRotacion.forEach(producto => {
                    html += `
                        <div style="background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px;
                                    border-left: 5px solid #28a745;">
                            <strong>${producto.nombre}</strong>
                            <br>Stock: ${producto.stockActual} (${producto.diasDeStock} d√≠as)
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            // Productos sin movimiento
            if (recomendaciones.sinMovimiento.length > 0) {
                html += `
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 25px; 
                                border-radius: 20px; margin-bottom: 25px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                        <h4 style="color: #856404; margin: 0 0 20px 0; font-size: 1.5em;">
                            üì¶ Productos Sin Movimiento (√öltimo Mes)
                        </h4>
                `;
                recomendaciones.sinMovimiento.forEach(producto => {
                    html += `
                        <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.9); 
                                    border-radius: 10px; border-left: 5px solid #ffc107;">
                            <strong>${producto.nombre}</strong> - Stock: ${producto.stockActual} unidades
                            <br><small style="color: #856404;">üí° Considera promociones o descuentos</small>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            // Resumen general
            const totalStock = Object.values(sistemaData.inventario).reduce((sum, stock) => sum + stock, 0);
            const productosConStock = Object.values(sistemaData.inventario).filter(stock => stock > 0).length;
            const productosAgotados = Object.values(sistemaData.inventario).filter(stock => stock === 0).length;
            
            html += `
                <div style="background: linear-gradient(135deg, #e7f3ff, #b3d9ff); padding: 30px; 
                            border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);">
                    <h4 style="margin: 0 0 25px 0; font-size: 1.5em; color: var(--dark);">
                        üìä Resumen de Inventario
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div style="text-align: center; background: white; padding: 20px; border-radius: 15px;">
                            <div style="font-size: 2.5em; font-weight: 700; color: #007bff;">${totalStock}</div>
                            <div style="font-weight: 600; color: #666;">Unidades Totales</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 20px; border-radius: 15px;">
                            <div style="font-size: 2.5em; font-weight: 700; color: #28a745;">${productosConStock}</div>
                            <div style="font-weight: 600; color: #666;">Productos con Stock</div>
                        </div>
                        <div style="text-align: center; background: white; padding: 20px; border-radius: 15px;">
                            <div style="font-size: 2.5em; font-weight: 700; color: #dc3545;">${productosAgotados}</div>
                            <div style="font-weight: 600; color: #666;">Productos Agotados</div>
                        </div>
                    </div>
                </div>
            `;
            
            html += '</div>';
            
            // Crear un modal temporal para mostrar las recomendaciones
            const modalTemp = document.createElement('div');
            modalTemp.className = 'modal';
            modalTemp.style.display = 'block';
            modalTemp.innerHTML = `
                <div class="modal-content" style="max-width: 1000px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove(); document.body.style.overflow='auto';">&times;</span>
                    ${html}
                </div>
            `;
            document.body.appendChild(modalTemp);
            document.body.style.overflow = 'hidden';
        }

        // Funci√≥n para cancelar venta
        function mostrarCancelarVenta() {
            // Filtrar ventas del d√≠a actual
            const hoy = obtenerFechaMexico();
            const ventasHoy = sistemaData.ventas.filter(venta => venta.fecha.split('T')[0] === hoy);
            
            let html = '<h3 style="color: var(--dark); margin-bottom: 25px;">‚ùå Cancelar Venta del D√≠a</h3>';
            
            if (ventasHoy.length === 0) {
                html += '<p style="text-align: center; color: #666; font-size: 1.1em;">No hay ventas registradas hoy para cancelar.</p>';
                document.getElementById('listadoVentasContent').innerHTML = html;
                mostrarModal('cancelarVentaModal');
                return;
            }
            
            html += '<div style="max-height: 500px; overflow-y: auto;">';
            
            ventasHoy.forEach((venta, index) => {
                const hora = new Date(venta.fecha).toLocaleTimeString('es-MX', {
                    timeZone: timeZone,
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let detalleVenta = '';
                if (venta.productos && Array.isArray(venta.productos)) {
                    // Venta m√∫ltiple
                    detalleVenta = venta.productos.map(p => 
                        `${p.sabor} ${p.tama√±o}g x${p.cantidad}`
                    ).join(', ');
                } else {
                    // Venta simple
                    detalleVenta = `${venta.producto} x${venta.cantidad}`;
                }
                
                const tipoEmoji = venta.tipo_venta === 'mayoreo' ? 'üè™' : 'üõí';
                
                html += `
                    <div style="background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; margin: 15px 0; 
                                border-radius: 15px; border-left: 6px solid #dc3545;
                                box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: var(--transition);"
                         onmouseover="this.style.transform='translateX(5px)'"
                         onmouseout="this.style.transform='translateX(0)'">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong style="font-size: 1.2em;">${tipoEmoji} ${hora}</strong> - ${detalleVenta}
                                <br>Total: <strong style="color: var(--primary);">${venta.total_venta.toFixed(2)}</strong>
                                ${venta.id ? '' : '<br><small style="color: #dc3545;">‚ö†Ô∏è Venta sin ID - No se puede cancelar</small>'}
                            </div>
                            ${venta.id ? `
                                <button class="btn btn-danger btn-sm" onclick="confirmarCancelacionVenta('${venta.id}')">
                                    ‚ùå CANCELAR
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('listadoVentasContent').innerHTML = html;
            mostrarModal('cancelarVentaModal');
        }
        
        async function confirmarCancelacionVenta(ventaId) {
            if (!confirm('¬øEst√°s seguro de cancelar esta venta? Se devolver√° el stock al inventario.')) {
                return;
            }
            
            try {
                actualizarEstadoSync('syncing');
                
                // Buscar la venta
                const venta = sistemaData.ventas.find(v => v.id === ventaId);
                if (!venta) {
                    mostrarAlerta('‚ùå No se encontr√≥ la venta', 'error');
                    return;
                }
                
                // Devolver stock al inventario
                const batch = db.batch();
                
                if (venta.productos && Array.isArray(venta.productos)) {
                    // Venta m√∫ltiple
                    for (const producto of venta.productos) {
                        const stockActual = sistemaData.inventario[producto.codigo] || 0;
                        const invRef = db.collection('inventario').doc(producto.codigo);
                        batch.set(invRef, { cantidad: stockActual + producto.cantidad });
                        
                        // Actualizar localmente
                        sistemaData.inventario[producto.codigo] = stockActual + producto.cantidad;
                    }
                } else if (venta.codigo) {
                    // Venta simple
                    const stockActual = sistemaData.inventario[venta.codigo] || 0;
                    const invRef = db.collection('inventario').doc(venta.codigo);
                    batch.set(invRef, { cantidad: stockActual + venta.cantidad });
                    
                    // Actualizar localmente
                    sistemaData.inventario[venta.codigo] = stockActual + venta.cantidad;
                }
                
                // Eliminar la venta
                const ventaRef = db.collection('ventas').doc(ventaId);
                batch.delete(ventaRef);
                
                await batch.commit();
                
                // Actualizar datos locales
                sistemaData.ventas = sistemaData.ventas.filter(v => v.id !== ventaId);
                
                mostrarAlerta('‚úÖ Venta cancelada y stock devuelto', 'success');
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('cancelarVentaModal');
                
            } catch (error) {
                console.error('Error al cancelar venta:', error);
                mostrarAlerta('‚ùå Error al cancelar la venta', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Conversi√≥n de stock
        function actualizarInfoConversion() {
            const tipo = document.getElementById('tipoConversion').value;
            const labelCantidad = document.getElementById('labelCantidadConvertir');
            
            if (tipo === '100a50') {
                labelCantidad.textContent = 'Cantidad de bolsas de 100g a convertir';
            } else if (tipo === '50a100') {
                labelCantidad.textContent = 'Cantidad de bolsas de 50g a convertir';
            }
            
            mostrarStockConversion();
        }
        
        function mostrarStockConversion() {
            const tipo = document.getElementById('tipoConversion').value;
            const sabor = document.getElementById('saborConvertir').value;
            
            if (!tipo || !sabor) {
                document.getElementById('stockConversionInfo').classList.add('hidden');
                return;
            }
            
            let codigoOrigen, codigoDestino, factorConversion;
            
            if (tipo === '100a50') {
                codigoOrigen = `${sabor}_100g`;
                codigoDestino = `${sabor}_50g`;
                factorConversion = 2;
            } else {
                codigoOrigen = `${sabor}_50g`;
                codigoDestino = `${sabor}_100g`;
                factorConversion = 0.5;
            }
            
            const stockOrigen = sistemaData.inventario[codigoOrigen] || 0;
            const stockDestino = sistemaData.inventario[codigoDestino] || 0;
            
            document.getElementById('stockOrigenTexto').innerHTML = 
                `Stock actual ${tipo === '100a50' ? '100g' : '50g'}: <strong>${stockOrigen}</strong> unidades`;
            
            document.getElementById('stockConversionInfo').classList.remove('hidden');
            document.getElementById('cantidadConvertir').max = tipo === '50a100' ? Math.floor(stockOrigen / 2) : stockOrigen;
            
            calcularResultadoConversion();
        }
        
        function calcularResultadoConversion() {
            const tipo = document.getElementById('tipoConversion').value;
            const cantidad = parseInt(document.getElementById('cantidadConvertir').value) || 0;
            
            if (!tipo || cantidad === 0) {
                document.getElementById('conversionResultado').innerHTML = '';
                return;
            }
            
            let resultado;
            if (tipo === '100a50') {
                resultado = cantidad * 2;
                document.getElementById('conversionResultado').innerHTML = 
                    `<strong>Resultado:</strong> ${cantidad} bolsas de 100g ‚Üí <strong>${resultado}</strong> bolsas de 50g`;
            } else {
                resultado = Math.floor(cantidad / 2);
                const sobrante = cantidad % 2;
                document.getElementById('conversionResultado').innerHTML = 
                    `<strong>Resultado:</strong> ${cantidad} bolsas de 50g ‚Üí <strong>${resultado}</strong> bolsas de 100g` +
                    (sobrante > 0 ? ` <small>(sobra ${sobrante} bolsa de 50g)</small>` : '');
            }
        }
        
        async function convertirStock(event) {
            event.preventDefault();
            
            const tipo = document.getElementById('tipoConversion').value;
            const sabor = document.getElementById('saborConvertir').value;
            const cantidad = parseInt(document.getElementById('cantidadConvertir').value);
            
            let codigoOrigen, codigoDestino, cantidadOrigen, cantidadDestino, tama√±oOrigen, tama√±oDestino;
            
            if (tipo === '100a50') {
                codigoOrigen = `${sabor}_100g`;
                codigoDestino = `${sabor}_50g`;
                cantidadOrigen = cantidad;
                cantidadDestino = cantidad * 2;
                tama√±oOrigen = 100;
                tama√±oDestino = 50;
            } else {
                codigoOrigen = `${sabor}_50g`;
                codigoDestino = `${sabor}_100g`;
                cantidadOrigen = cantidad;
                cantidadDestino = Math.floor(cantidad / 2);
                tama√±oOrigen = 50;
                tama√±oDestino = 100;
            }
            
            const stockOrigen = sistemaData.inventario[codigoOrigen] || 0;
            
            // Validar stock suficiente
            if (stockOrigen < cantidadOrigen) {
                mostrarAlerta('‚ùå Stock insuficiente para realizar la conversi√≥n', 'error');
                return;
            }
            
            // Validar que la conversi√≥n tenga sentido
            if (tipo === '50a100' && cantidad < 2) {
                mostrarAlerta('‚ùå Necesitas al menos 2 bolsas de 50g para crear una de 100g', 'error');
                return;
            }
            
            try {
                actualizarEstadoSync('syncing');
                
                // Registrar la conversi√≥n
                const conversion = {
                    fecha: new Date().toISOString(),
                    sabor: sabor,
                    tipo: tipo,
                    cantidad_origen: cantidadOrigen,
                    tama√±o_origen: tama√±oOrigen,
                    cantidad_destino: cantidadDestino,
                    tama√±o_destino: tama√±oDestino
                };
                
                await db.collection('conversiones').add(conversion);
                
                // Actualizar inventarios
                const batch = db.batch();
                
                // Reducir stock origen
                const nuevoStockOrigen = stockOrigen - cantidadOrigen;
                batch.set(db.collection('inventario').doc(codigoOrigen), { cantidad: nuevoStockOrigen });
                
                // Aumentar stock destino
                const stockDestinoActual = sistemaData.inventario[codigoDestino] || 0;
                const nuevoStockDestino = stockDestinoActual + cantidadDestino;
                batch.set(db.collection('inventario').doc(codigoDestino), { cantidad: nuevoStockDestino });
                
                await batch.commit();
                
                // Actualizar localmente
                sistemaData.inventario[codigoOrigen] = nuevoStockOrigen;
                sistemaData.inventario[codigoDestino] = nuevoStockDestino;
                sistemaData.conversiones.push(conversion);
                
                const saborTitulo = sabor.charAt(0).toUpperCase() + sabor.slice(1);
                mostrarAlerta(`‚úÖ Conversi√≥n exitosa<br>${cantidadOrigen}x ${saborTitulo} ${tama√±oOrigen}g ‚Üí ${cantidadDestino}x ${saborTitulo} ${tama√±oDestino}g`, 'success');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('convertirStockModal');
                
            } catch (error) {
                console.error('Error al convertir stock:', error);
                mostrarAlerta('‚ùå Error al realizar la conversi√≥n', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Registrar env√≠o
        function actualizarPrecioEnvio() {
            calcularTotalEnvio();
        }
        
        function calcularTotalEnvio() {
            const tama√±o = parseInt(document.getElementById('tama√±oEnvio').value);
            const cantidad = parseInt(document.getElementById('cantidadEnvio').value) || 0;
            const tipoPrecio = document.getElementById('tipoPrecioEnvio').value;
            const costoEnvio = parseFloat(document.getElementById('costoEnvio').value) || 0;
            
            if (!tama√±o || cantidad === 0) {
                document.getElementById('subtotalEnvio').textContent = '0.00';
                document.getElementById('costoEnvioMostrar').textContent = '0.00';
                document.getElementById('totalEnvio').textContent = '0.00';
                return;
            }
            
            const precioUnitario = tipoPrecio === 'mayoreo' ? 
                sistemaData.precios_mayoreo[tama√±o] : 
                sistemaData.precios_menudeo[tama√±o];
            
            const subtotal = precioUnitario * cantidad;
            const total = subtotal + costoEnvio;
            
            document.getElementById('subtotalEnvio').textContent = subtotal.toFixed(2);
            document.getElementById('costoEnvioMostrar').textContent = costoEnvio.toFixed(2);
            document.getElementById('totalEnvio').textContent = total.toFixed(2);
        }
        
        async function registrarEnvio(event) {
            event.preventDefault();
            
            const cliente = document.getElementById('clienteEnvio').value;
            const sabor = document.getElementById('saborEnvio').value;
            const tama√±o = parseInt(document.getElementById('tama√±oEnvio').value);
            const cantidad = parseInt(document.getElementById('cantidadEnvio').value);
            const tipoPrecio = document.getElementById('tipoPrecioEnvio').value;
            const costoEnvio = parseFloat(document.getElementById('costoEnvio').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                mostrarAlerta(`‚ùå Stock insuficiente! Disponible: ${stockActual}`, 'error');
                return;
            }
            
            try {
                actualizarEstadoSync('syncing');
                
                const precioUnitario = tipoPrecio === 'mayoreo' ? 
                    sistemaData.precios_mayoreo[tama√±o] : 
                    sistemaData.precios_menudeo[tama√±o];
                
                const subtotal = precioUnitario * cantidad;
                const totalVenta = subtotal + costoEnvio;
                const costoProducto = (sistemaData.costos_unitarios[codigo] || 0) * cantidad;
                const ganancia = totalVenta - costoProducto - costoEnvio; // La ganancia descuenta el costo de env√≠o
                
                const envio = {
                    fecha: new Date().toISOString(),
                    cliente: cliente,
                    producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} ${tama√±o}g`,
                    codigo: codigo,
                    cantidad: cantidad,
                    tipo_precio: tipoPrecio,
                    precio_unitario: precioUnitario,
                    subtotal_producto: subtotal,
                    costo_envio: costoEnvio,
                    total_venta: totalVenta,
                    costo_producto: costoProducto,
                    ganancia: ganancia
                };
                
                const docRef = await db.collection('envios').add(envio);
                envio.id = docRef.id;
                
                // Actualizar inventario
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                // Actualizar localmente
                sistemaData.envios.push(envio);
                sistemaData.inventario[codigo] = stockActual - cantidad;
                
                mostrarAlerta(`‚úÖ Env√≠o registrado<br>Cliente: ${cliente}<br>Total cobrado: ${totalVenta.toFixed(2)}`, 'success');
                
                actualizarEstadisticas();
                actualizarEstadoSync('online');
                cerrarModal('envioModal');
                
                // Limpiar formulario
                document.getElementById('clienteEnvio').value = '';
                document.getElementById('saborEnvio').value = '';
                document.getElementById('tama√±oEnvio').value = '';
                document.getElementById('cantidadEnvio').value = '';
                document.getElementById('costoEnvio').value = '';
                
            } catch (error) {
                console.error('Error al registrar env√≠o:', error);
                mostrarAlerta('‚ùå Error al registrar env√≠o', 'error');
                actualizarEstadoSync('offline');
            }
        }

        // Actualizar estad√≠sticas
        function actualizarEstadisticas() {
            const hoy = obtenerFechaMexico();
            
            // Ventas del d√≠a
            const ventasHoy = sistemaData.ventas.filter(venta => venta.fecha.split('T')[0] === hoy);
            const enviosHoy = sistemaData.envios.filter(envio => envio.fecha.split('T')[0] === hoy);
            
            let totalVentasHoy = 0;
            let totalIngresosHoy = 0;
            
            ventasHoy.forEach(venta => {
                totalVentasHoy += venta.cantidad_total || venta.cantidad || 0;
                totalIngresosHoy += venta.total_venta;
            });
            
            enviosHoy.forEach(envio => {
                totalVentasHoy += envio.cantidad;
                totalIngresosHoy += envio.total_venta;
            });
            
            // Total productos en stock
            let totalStock = 0;
            Object.values(sistemaData.inventario).forEach(stock => {
                totalStock += stock;
            });
            
            // Actualizar DOM con animaci√≥n
            animarNumero('ventasHoy', totalVentasHoy);
            animarNumero('ingresosHoy', totalIngresosHoy, 'ioMenudeo = sistemaData.precios_menudeo[tama√±o];
                
                html += `
                    <div class="product-card">
                        <div class="product-name">${saborTitulo} ${tama√±o}g</div>
                        <div class="stock-info">
                            <span>Stock: <strong>${stock}</strong></span>
                            <span class="stock-badge ${estadoClass}">${estadoTexto}</span>
                        </div>
                        <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                            <div style="background: white; padding: 10px; border-radius: 10px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>Mayoreo:</span>
                                    <strong>$${precioMayoreo.toFixed(2)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>Menudeo:</span>
                                    <strong>$${precioMenudeo.toFixed(2)}</strong>
                                </div>
                                <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>Costo base:</span>
                                    <strong style="color: var(--primary);">$${costo.toFixed(2)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('inventarioContent').innerHTML = html;
            mostrarModal('inventarioModal');
        }

        // Actualizar costos
        async function actualizarCostos(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborCosto').value;
            const tama√±o = parseInt(document.getElementById('tama√±oCosto').value);
            const costo = parseFloat(document.getElementById('costoProduccion').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            
            try {
                actualizarEstadoSync('syncing');
                
                // Actualizar en Firebase
                await db.collection('costos').doc(codigo).set({
                    costo: costo
                });
                
                // Actualizar localmente
                sistemaData.costos_unitarios[codigo] = costo;
                
                const precioMayoreo = sistemaData.precios_mayoreo[tama√±o];
                const prec, true);
            animarNumero('productosStock', totalStock);
        }

        // Animar n√∫meros
        function animarNumero(elementId, valorFinal, prefijo = '', esDecimal = false) {
            const element = document.getElementById(elementId);
            const valorInicial = parseInt(element.textContent.replace(/[^0-9]/g, '')) || 0;
            const duracion = 1000;
            const incremento = (valorFinal - valorInicial) / (duracion / 16);
            let valorActual = valorInicial;
            
            const intervalo = setInterval(() => {
                valorActual += incremento;
                if ((incremento > 0 && valorActual >= valorFinal) || 
                    (incremento < 0 && valorActual <= valorFinal)) {
                    valorActual = valorFinal;
                    clearInterval(intervalo);
                }
                
                if (esDecimal) {
                    element.textContent = prefijo + Math.round(valorActual);
                } else {
                    element.textContent = Math.round(valorActual);
                }
            }, 16);
        }

        // Mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'info', duracion = 3000) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertDiv = document.createElement('div');
            alertDiv.id = alertId;
            alertDiv.className = `alert alert-${tipo}`;
            alertDiv.style.cssText = `
                margin-bottom: 15px;
                padding: 20px 25px;
                border-radius: 15px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                min-width: 300px;
                max-width: 500px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 15px;
            `;
            
            // Agregar icono seg√∫n el tipo
            const iconos = {
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è',
                'info': '‚ÑπÔ∏è'
            };
            
            alertDiv.innerHTML = `<span style="font-size: 1.5em;">${iconos[tipo] || ''}</span><div>${mensaje}</div>`;
            
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    alertDiv.remove();
                }, 300);
            }, duracion);
        }

        // Animaciones CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Cerrar modales con ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modales = document.querySelectorAll('.modal');
                modales.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                    }
                });
            }
        });

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // Inicializar aplicaci√≥n
        window.onload = function() {
            verificarSesion();
        };

        // Prevenir cierre accidental
        window.addEventListener('beforeunload', function (e) {
            if (usuarioAutenticado && (carritoVenta.length > 0 || carritoRecepcion.length > 0)) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>ioMenudeo = sistemaData.precios_menudeo[tama√±o];
                
                html += `
                    <div class="product-card">
                        <div class="product-name">${saborTitulo} ${tama√±o}g</div>
                        <div class="stock-info">
                            <span>Stock: <strong>${stock}</strong></span>
                            <span class="stock-badge ${estadoClass}">${estadoTexto}</span>
                        </div>
                        <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
                            <div style="background: white; padding: 10px; border-radius: 10px; margin-top: 10px;">
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>Mayoreo:</span>
                                    <strong>$${precioMayoreo.toFixed(2)}</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>Menudeo:</span>
                                    <strong>$${precioMenudeo.toFixed(2)}</strong>
                                </div>
                                <hr style="margin: 10px 0; border: none; border-top: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                                    <span>Costo base:</span>
                                    <strong style="color: var(--primary);">$${costo.toFixed(2)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('inventarioContent').innerHTML = html;
            mostrarModal('inventarioModal');
        }

        // Actualizar costos
        async function actualizarCostos(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborCosto').value;
            const tama√±o = parseInt(document.getElementById('tama√±oCosto').value);
            const costo = parseFloat(document.getElementById('costoProduccion').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            
            try {
                actualizarEstadoSync('syncing');
                
                // Actualizar en Firebase
                await db.collection('costos').doc(codigo).set({
                    costo: costo
                });
                
                // Actualizar localmente
                sistemaData.costos_unitarios[codigo] = costo;
                
                const precioMayoreo = sistemaData.precios_mayoreo[tama√±o];
                const prec