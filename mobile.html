<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Malangu√≠simas - App M√≥vil</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Malangu√≠simas">
    <meta name="theme-color" content="#d73027">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22Malangu√≠simas%20Inventario%22,%22short_name%22:%22Malangu√≠simas%22,%22start_url%22:%22/%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f5f5f5%22,%22theme_color%22:%22%23d73027%22,%22orientation%22:%22portrait%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20512%20512'%3E%3Crect%20width='512'%20height='512'%20fill='%23d73027'/%3E%3Ctext%20x='256'%20y='380'%20font-size='350'%20text-anchor='middle'%20fill='white'%3Eüå∂Ô∏è%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%23d73027'/><text x='90' y='140' font-size='120' text-anchor='middle' fill='white'>üå∂Ô∏è</text></svg>">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='80' font-size='80'>üå∂Ô∏è</text></svg>">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        :root {
            --primary: #d73027;
            --primary-dark: #a94442;
            --secondary: #ff6b35;
            --success: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --info: #2196F3;
            --background: #f5f5f5;
            --surface: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
            --radius: 16px;
            --radius-lg: 24px;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--background);
            color: var(--text);
            overflow-x: hidden;
            position: relative;
            height: 100vh;
            touch-action: pan-y;
        }
        
        /* Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #ff6b35 0%, #d73027 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }
        
        .login-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 30px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .login-logo {
            font-size: 4em;
            margin-bottom: 10px;
        }
        
        .login-title {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: var(--text-light);
            margin-bottom: 30px;
        }
        
        /* App Container */
        .app-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            flex-direction: column;
        }
        
        .app-container.active {
            display: flex;
        }
        
        /* Header */
        .app-header {
            background: var(--primary);
            color: white;
            padding: calc(var(--safe-area-top) + 16px) 20px 16px;
            box-shadow: var(--shadow);
            position: relative;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-title {
            font-size: 1.3em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.offline {
            background: var(--danger);
            animation: none;
        }
        
        .sync-indicator.syncing {
            background: var(--warning);
            animation: spin 1s linear infinite;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(80px + var(--safe-area-bottom));
        }
        
        /* Tab Views */
        .tab-view {
            display: none;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        .tab-view.active {
            display: block;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding-bottom: var(--safe-area-bottom);
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            border: none;
            background: none;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item .icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }
        
        .nav-item .label {
            font-size: 0.75em;
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 2px;
            background: var(--primary);
            border-radius: 2px;
        }
        
        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .card:active {
            transform: scale(0.98);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .card-title {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary);
        }
        
        /* Quick Actions Grid */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .action-button {
            background: var(--surface);
            border: 1px solid #e0e0e0;
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-button:active {
            transform: scale(0.95);
        }
        
        .action-button.primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
        }
        
        .action-button.success {
            background: linear-gradient(135deg, var(--success) 0%, #388E3C 100%);
            color: white;
            border: none;
        }
        
        .action-button.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #F57C00 100%);
            color: white;
            border: none;
        }
        
        .action-button.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #C62828 100%);
            color: white;
            border: none;
        }
        
        .action-button.secondary {
            background: linear-gradient(135deg, #9E9E9E 0%, #616161 100%);
            color: white;
            border: none;
        }
        
        .action-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .action-label {
            font-size: 0.9em;
            font-weight: 500;
        }
        
        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .product-card {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--secondary);
        }
        
        .product-name {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .product-stock {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stock-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            color: white;
        }
        
        .stock-good { background: var(--success); }
        .stock-low { background: var(--warning); }
        .stock-out { background: var(--danger); }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            background: var(--surface);
            transition: all 0.3s ease;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(215, 48, 39, 0.1);
        }
        
        /* Buttons */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            box-shadow: 0 4px 12px rgba(215, 48, 39, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #388E3C 100%);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #F57C00 100%);
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #C62828 100%);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #9E9E9E 0%, #616161 100%);
            box-shadow: 0 4px 12px rgba(158, 158, 158, 0.3);
        }
        
        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            padding: 20px;
            padding-bottom: calc(20px + var(--safe-area-bottom));
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: sticky;
            top: -20px;
            background: var(--surface);
            padding: 10px 0;
            z-index: 10;
        }
        
        .modal-title {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--primary);
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2em;
            color: var(--text-light);
        }
        
        /* Carrito */
        .cart-container {
            background: #f8f9fa;
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .cart-item:last-child {
            border-bottom: none;
        }
        
        .cart-empty {
            text-align: center;
            color: var(--text-light);
            padding: 20px;
        }
        
        .cart-remove {
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: calc(var(--safe-area-top) + 20px);
            left: 50%;
            transform: translateX(-50%);
            z-index: 3000;
            pointer-events: none;
        }
        
        .toast {
            background: var(--surface);
            border-radius: var(--radius);
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: calc(100vw - 40px);
            pointer-events: auto;
            animation: slideDown 0.3s ease;
        }
        
        .toast-icon {
            font-size: 1.5em;
        }
        
        .toast-message {
            flex: 1;
        }
        
        .toast.success { border-left: 4px solid var(--success); }
        .toast.warning { border-left: 4px solid var(--warning); }
        .toast.error { border-left: 4px solid var(--danger); }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Loading Spinner */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* Responsive */
        @media (min-width: 768px) {
            .quick-actions {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* Safe area adjustments */
        @supports (padding: max(0px)) {
            .app-header {
                padding-top: max(16px, var(--safe-area-top));
            }
            
            .bottom-nav {
                padding-bottom: max(0px, var(--safe-area-bottom));
            }
            
            .main-content {
                padding-bottom: max(80px, calc(80px + var(--safe-area-bottom)));
            }
        }
        
        /* Pull to refresh indicator */
        .pull-to-refresh {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* FAB */
        .fab {
            position: fixed;
            bottom: calc(90px + var(--safe-area-bottom));
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(215, 48, 39, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 900;
        }
        
        .fab:active {
            transform: scale(0.9);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-icon {
            font-size: 4em;
            margin-bottom: 16px;
            opacity: 0.5;
        }
        
        .empty-text {
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        .empty-subtext {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">üå∂Ô∏è</div>
            <h1 class="login-title">Malangu√≠simas</h1>
            <p class="login-subtitle">Sistema de Inventario</p>
            
            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="password" 
                           id="loginPassword" 
                           class="form-input" 
                           placeholder="C√≥digo de acceso"
                           required>
                </div>
                <button type="submit" class="btn btn-primary">
                    <span>üîê</span>
                    <span>Ingresar</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- App Container -->
    <div id="appContainer" class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <span>üå∂Ô∏è Malangu√≠simas</span>
                    <div id="syncIndicator" class="sync-indicator"></div>
                </div>
                <button onclick="syncData()" style="background: none; border: none; color: white; font-size: 1.2em;">
                    üîÑ
                </button>
            </div>
        </header>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Pull to refresh -->
            <div class="pull-to-refresh">
                <div class="spinner" style="display: none;"></div>
            </div>
            
            <!-- Inicio Tab -->
            <div id="tabInicio" class="tab-view active">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="ventasHoy">0</div>
                        <div class="stat-label">Ventas Hoy</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ingresosHoy">$0</div>
                        <div class="stat-label">Ingresos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="productosStock">0</div>
                        <div class="stat-label">En Stock</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ultimaSync">--:--</div>
                        <div class="stat-label">√öltima Sync</div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <h3 style="margin: 20px 0 12px;">Acciones R√°pidas</h3>
                <div class="quick-actions">
                    <button class="action-button primary" onclick="prepararVenta('menudeo')">
                        <div class="action-icon">üõí</div>
                        <div class="action-label">Venta R√°pida</div>
                    </button>
                    <button class="action-button success" onclick="showModal('agregarStock')">
                        <div class="action-icon">‚ûï</div>
                        <div class="action-label">Agregar Stock</div>
                    </button>
                    <button class="action-button warning" onclick="showModal('recepcion')">
                        <div class="action-icon">üì¶</div>
                        <div class="action-label">Recepci√≥n</div>
                    </button>
                    <button class="action-button" onclick="showReportes()">
                        <div class="action-icon">üìä</div>
                        <div class="action-label">Reportes</div>
                    </button>
                </div>
                
                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà Actividad Reciente</h3>
                    </div>
                    <div id="actividadReciente">
                        <div class="empty-state">
                            <div class="empty-icon">üìã</div>
                            <div class="empty-text">Sin actividad reciente</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventario Tab -->
            <div id="tabInventario" class="tab-view">
                <h2 style="margin-bottom: 20px;">üì¶ Inventario</h2>
                
                <!-- Search Bar -->
                <div class="form-group">
                    <input type="search" 
                           class="form-input" 
                           placeholder="Buscar producto..."
                           onkeyup="buscarProducto(this.value)">
                </div>
                
                <!-- Product Grid -->
                <div id="productGrid" class="product-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Ventas Tab -->
            <div id="tabVentas" class="tab-view">
                <h2 style="margin-bottom: 20px;">üí∞ Ventas</h2>
                
                <div class="quick-actions">
                    <button class="action-button primary" onclick="prepararVenta('menudeo')">
                        <div class="action-icon">üõí</div>
                        <div class="action-label">Menudeo</div>
                    </button>
                    <button class="action-button success" onclick="prepararVenta('mayoreo')">
                        <div class="action-icon">üè™</div>
                        <div class="action-label">Mayoreo</div>
                    </button>
                    <button class="action-button warning" onclick="showModal('envio')">
                        <div class="action-icon">üì¶</div>
                        <div class="action-label">Env√≠o</div>
                    </button>
                    <button class="action-button" onclick="showModal('regalada')">
                        <div class="action-icon">üéÅ</div>
                        <div class="action-label">Muestra</div>
                    </button>
                    <button class="action-button danger" onclick="showModal('cancelarVenta')">
                        <div class="action-icon">‚ùå</div>
                        <div class="action-label">Cancelar</div>
                    </button>
                    <button class="action-button secondary" onclick="showModal('quitarStock')">
                        <div class="action-icon">‚ûñ</div>
                        <div class="action-label">Quitar Stock</div>
                    </button>
                </div>
                
                <!-- Sales History -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Historial de Ventas</h3>
                    </div>
                    <div id="historialVentas">
                        <div class="empty-state">
                            <div class="empty-icon">üí∞</div>
                            <div class="empty-text">Sin ventas registradas</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- M√°s Tab -->
            <div id="tabMas" class="tab-view">
                <h2 style="margin-bottom: 20px;">‚öôÔ∏è M√°s Opciones</h2>
                
                <div class="card" onclick="showModal('gastos')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">üí∏</span>
                            <span>Registrar Gasto</span>
                        </div>
                        <span style="color: var(--text-light);">‚Ä∫</span>
                    </div>
                </div>
                
                <div class="card" onclick="showModal('convertir')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">üîÑ</span>
                            <span>Convertir Tama√±os</span>
                        </div>
                        <span style="color: var(--text-light);">‚Ä∫</span>
                    </div>
                </div>
                
                <div class="card" onclick="showModal('costos')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">üí∞</span>
                            <span>Actualizar Costos</span>
                        </div>
                        <span style="color: var(--text-light);">‚Ä∫</span>
                    </div>
                </div>
                
                <div class="card" onclick="showTendencias()">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">üìà</span>
                            <span>Tendencias</span>
                        </div>
                        <span style="color: var(--text-light);">‚Ä∫</span>
                    </div>
                </div>
                
                <div class="card" onclick="showFlujoEfectivo()">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 1.5em;">üíµ</span>
                            <span>Flujo de Efectivo</span>
                        </div>
                        <span style="color: var(--text-light);">‚Ä∫</span>
                    </div>
                </div>
                
                <div class="card" onclick="logout()" style="border: 1px solid var(--danger); background: #ffebee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 12px; color: var(--danger);">
                            <span style="font-size: 1.5em;">üö™</span>
                            <span>Cerrar Sesi√≥n</span>
                        </div>
                        <span style="color: var(--danger);">‚Ä∫</span>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-container">
                <button class="nav-item active" onclick="switchTab('Inicio')">
                    <span class="icon">üè†</span>
                    <span class="label">Inicio</span>
                </button>
                <button class="nav-item" onclick="switchTab('Inventario')">
                    <span class="icon">üì¶</span>
                    <span class="label">Inventario</span>
                </button>
                <button class="nav-item" onclick="switchTab('Ventas')">
                    <span class="icon">üí∞</span>
                    <span class="label">Ventas</span>
                </button>
                <button class="nav-item" onclick="switchTab('Mas')">
                    <span class="icon">‚öôÔ∏è</span>
                    <span class="label">M√°s</span>
                </button>
            </div>
        </nav>
        
        <!-- FAB for quick sale -->
        <button class="fab" onclick="prepararVenta('menudeo')">
            <span>üõí</span>
        </button>
    </div>
    
    <!-- Modals -->
    <!-- Venta M√∫ltiple Modal -->
    <div id="modalVentaMultiple" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="tituloVentaMultiple">üõí Venta</h3>
                <button class="modal-close" onclick="closeModal('ventaMultiple')">‚úï</button>
            </div>
            
            <!-- Agregar productos -->
            <div class="card" style="background: #f0f0f0;">
                <h4 style="margin-bottom: 12px;">Agregar Producto</h4>
                <div style="display: grid; gap: 12px;">
                    <div class="form-group" style="margin: 0;">
                        <select id="saborCarrito" class="form-select">
                            <option value="">Selecciona sabor</option>
                            <option value="fuego">üî• Fuego</option>
                            <option value="misterio">üåü Misterio</option>
                            <option value="habanero">ü´ë Habanero</option>
                            <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                            <option value="adobadas">üçÖ Adobadas</option>
                            <option value="naturales">üßÇ Naturales</option>
                            <option value="especias">‚ú® Especias</option>
                            <option value="chipotle">üî• Chipotle</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <select id="tama√±oCarrito" class="form-select">
                            <option value="">Tama√±o</option>
                            <option value="50">50g</option>
                            <option value="100">100g</option>
                        </select>
                        <input type="number" id="cantidadCarrito" class="form-input" placeholder="Cantidad" min="1">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="agregarAlCarrito()">
                        ‚ûï Agregar al Carrito
                    </button>
                </div>
            </div>
            
            <!-- Carrito -->
            <h4 style="margin: 16px 0 8px;">üõí Carrito</h4>
            <div class="cart-container">
                <div id="carritoVenta">
                    <div class="cart-empty">Carrito vac√≠o</div>
                </div>
            </div>
            
            <!-- Total -->
            <div class="card" style="background: #e8f5e9;">
                <div id="resumenVenta">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Subtotal:</span>
                        <span>$<span id="subtotalVenta">0.00</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 1.2em; font-weight: bold;">
                        <span>Total:</span>
                        <span style="color: var(--success);">$<span id="totalVentaMultiple">0.00</span></span>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-primary" onclick="confirmarVentaMultiple()" id="btnConfirmarVenta" disabled>
                üí∞ Confirmar Venta
            </button>
        </div>
    </div>
    
    <!-- Venta R√°pida Modal -->
    <div id="modalVentaRapida" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üõí Venta R√°pida</h3>
                <button class="modal-close" onclick="closeModal('ventaRapida')">‚úï</button>
            </div>
            
            <form onsubmit="procesarVentaRapida(event)">
                <div class="form-group">
                    <label class="form-label">Tipo de Venta</label>
                    <select id="tipoVentaRapida" class="form-select" onchange="actualizarPrecioVenta()">
                        <option value="menudeo">Menudeo</option>
                        <option value="mayoreo">Mayoreo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborVenta" class="form-select" required onchange="actualizarPrecioVenta()">
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tama√±o</label>
                    <select id="tama√±oVenta" class="form-select" required onchange="actualizarPrecioVenta()">
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" id="cantidadVenta" class="form-input" min="1" required onchange="actualizarPrecioVenta()">
                </div>
                
                <div class="card" style="background: #e8f5e9;">
                    <div style="text-align: center;">
                        <div style="font-size: 0.9em; color: var(--text-light);">Total a cobrar</div>
                        <div style="font-size: 2em; font-weight: bold; color: var(--success);" id="totalVentaRapida">$0.00</div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>üí∞</span>
                    <span>Confirmar Venta</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Agregar Stock Modal -->
    <div id="modalAgregarStock" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Agregar Stock</h3>
                <button class="modal-close" onclick="closeModal('agregarStock')">‚úï</button>
            </div>
            
            <form onsubmit="agregarStock(event)">
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborStock" class="form-select" required>
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tama√±o</label>
                    <select id="tama√±oStock" class="form-select" required>
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cantidad a agregar</label>
                    <input type="number" id="cantidadStock" class="form-input" min="1" required>
                </div>
                
                <button type="submit" class="btn btn-success">
                    <span>‚úÖ</span>
                    <span>Agregar al Inventario</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Quitar Stock Modal -->
    <div id="modalQuitarStock" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûñ Quitar Stock</h3>
                <button class="modal-close" onclick="closeModal('quitarStock')">‚úï</button>
            </div>
            
            <form onsubmit="quitarStock(event)">
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborQuitar" class="form-select" required onchange="mostrarStockActual()">
                        <option value="">Selecciona un sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tama√±o</label>
                    <select id="tama√±oQuitar" class="form-select" required onchange="mostrarStockActual()">
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                
                <div id="stockActualInfo" class="card" style="background: #fff3cd; display: none;">
                    Stock actual: <strong id="stockActualTexto">0</strong> unidades
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cantidad a quitar</label>
                    <input type="number" id="cantidadQuitar" class="form-input" min="1" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Motivo</label>
                    <select id="motivoQuitar" class="form-select">
                        <option value="da√±ado">Producto da√±ado</option>
                        <option value="vencido">Producto vencido</option>
                        <option value="perdida">P√©rdida/Robo</option>
                        <option value="ajuste">Ajuste de inventario</option>
                        <option value="otro">Otro</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-danger">
                    <span>‚ùå</span>
                    <span>Quitar del Stock</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Recepci√≥n Modal -->
    <div id="modalRecepcion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üì¶ Registrar Recepci√≥n</h3>
                <button class="modal-close" onclick="closeModal('recepcion')">‚úï</button>
            </div>
            
            <form onsubmit="registrarRecepcion(event)">
                <div class="form-group">
                    <label class="form-label">Origen</label>
                    <input type="text" id="origenRecepcion" class="form-input" value="Puebla" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">N√∫mero de gu√≠a</label>
                    <input type="text" id="guiaRecepcion" class="form-input" placeholder="Opcional">
                </div>
                
                <!-- Agregar productos -->
                <div class="card" style="background: #f0f0f0;">
                    <h4 style="margin-bottom: 12px;">Agregar Productos</h4>
                    <div style="display: grid; gap: 12px;">
                        <select id="saborRecepcion" class="form-select">
                            <option value="">Selecciona sabor</option>
                            <option value="fuego">üî• Fuego</option>
                            <option value="misterio">üåü Misterio</option>
                            <option value="habanero">ü´ë Habanero</option>
                            <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                            <option value="adobadas">üçÖ Adobadas</option>
                            <option value="naturales">üßÇ Naturales</option>
                            <option value="especias">‚ú® Especias</option>
                            <option value="chipotle">üî• Chipotle</option>
                        </select>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <select id="tama√±oRecepcion" class="form-select">
                                <option value="">Tama√±o</option>
                                <option value="50">50g</option>
                                <option value="100">100g</option>
                            </select>
                            <input type="number" id="cantidadRecepcion" class="form-input" placeholder="Cantidad" min="1">
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="agregarARecepcion()">
                            ‚ûï Agregar
                        </button>
                    </div>
                </div>
                
                <!-- Lista de productos -->
                <h4 style="margin: 16px 0 8px;">üìã Productos a Recibir</h4>
                <div class="cart-container">
                    <div id="listaRecepcion">
                        <div class="cart-empty">Sin productos</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Costo de env√≠o (opcional)</label>
                    <input type="number" id="costoEnvioRecepcion" class="form-input" step="0.01" placeholder="0.00">
                </div>
                
                <button type="submit" class="btn btn-primary" id="btnConfirmarRecepcion" disabled>
                    ‚úÖ Confirmar Recepci√≥n
                </button>
            </form>
        </div>
    </div>
    
    <!-- Gastos Modal -->
    <div id="modalGastos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üí∏ Registrar Gasto</h3>
                <button class="modal-close" onclick="closeModal('gastos')">‚úï</button>
            </div>
            
            <form onsubmit="registrarGasto(event)">
                <div class="form-group">
                    <label class="form-label">Concepto</label>
                    <input type="text" id="conceptoGasto" class="form-input" required placeholder="Ej: Compra de chiles">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Monto</label>
                    <input type="number" id="montoGasto" class="form-input" step="0.01" min="0" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Categor√≠a</label>
                    <select id="categoriaGasto" class="form-select">
                        <option value="operativo">Operativo</option>
                        <option value="materia_prima">Materia Prima</option>
                        <option value="transporte">Transporte</option>
                        <option value="equipamiento">Equipamiento</option>
                        <option value="otros">Otros</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-warning">
                    <span>üí∏</span>
                    <span>Registrar Gasto</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Env√≠o Modal -->
    <div id="modalEnvio" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üì¶ Registrar Env√≠o</h3>
                <button class="modal-close" onclick="closeModal('envio')">‚úï</button>
            </div>
            
            <form onsubmit="registrarEnvio(event)">
                <div class="form-group">
                    <label class="form-label">Cliente/Destino</label>
                    <input type="text" id="clienteEnvio" class="form-input" required placeholder="Nombre del cliente">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborEnvio" class="form-select" required>
                        <option value="">Selecciona sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tama√±o</label>
                    <select id="tama√±oEnvio" class="form-select" required onchange="calcularTotalEnvio()">
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" id="cantidadEnvio" class="form-input" min="1" required onchange="calcularTotalEnvio()">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de precio</label>
                    <select id="tipoPrecioEnvio" class="form-select" onchange="calcularTotalEnvio()">
                        <option value="mayoreo">Mayoreo</option>
                        <option value="menudeo">Menudeo</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Costo de env√≠o</label>
                    <input type="number" id="costoEnvio" class="form-input" step="0.01" min="0" required onchange="calcularTotalEnvio()">
                </div>
                
                <div class="card" style="background: #e3f2fd;">
                    <div style="font-size: 0.9em;">
                        <div>Subtotal: $<span id="subtotalEnvio">0.00</span></div>
                        <div>Env√≠o: $<span id="costoEnvioMostrar">0.00</span></div>
                        <div style="font-weight: bold; font-size: 1.1em; margin-top: 8px;">
                            Total: $<span id="totalEnvio">0.00</span>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>üì¶</span>
                    <span>Registrar Env√≠o</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Regalada Modal -->
    <div id="modalRegalada" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üéÅ Registrar Muestra</h3>
                <button class="modal-close" onclick="closeModal('regalada')">‚úï</button>
            </div>
            
            <form onsubmit="registrarRegalada(event)">
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborRegalada" class="form-select" required>
                        <option value="">Selecciona sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tama√±o</label>
                    <select id="tama√±oRegalada" class="form-select" required>
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cantidad</label>
                    <input type="number" id="cantidadRegalada" class="form-input" min="1" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Punto de venta (opcional)</label>
                    <input type="text" id="puntoVentaRegalada" class="form-input" placeholder="Ej: Tienda El Ahorro">
                </div>
                
                <button type="submit" class="btn btn-warning">
                    <span>üéÅ</span>
                    <span>Registrar Muestra</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Convertir Stock Modal -->
    <div id="modalConvertir" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üîÑ Convertir Tama√±os</h3>
                <button class="modal-close" onclick="closeModal('convertir')">‚úï</button>
            </div>
            
            <form onsubmit="convertirStock(event)">
                <div class="form-group">
                    <label class="form-label">Tipo de conversi√≥n</label>
                    <select id="tipoConversion" class="form-select" required onchange="actualizarInfoConversion()">
                        <option value="">Selecciona tipo</option>
                        <option value="100a50">100g ‚Üí 50g (1 = 2)</option>
                        <option value="50a100">50g ‚Üí 100g (2 = 1)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborConvertir" class="form-select" required onchange="mostrarStockConversion()">
                        <option value="">Selecciona sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div id="stockConversionInfo" class="card" style="background: #fff3cd; display: none;">
                    <div id="stockOrigenTexto"></div>
                    <div id="conversionResultado"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" id="labelCantidadConvertir">Cantidad a convertir</label>
                    <input type="number" id="cantidadConvertir" class="form-input" min="1" required onchange="calcularResultadoConversion()">
                </div>
                
                <button type="submit" class="btn btn-warning">
                    <span>üîÑ</span>
                    <span>Realizar Conversi√≥n</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Actualizar Costos Modal -->
    <div id="modalCostos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üí∞ Actualizar Costos</h3>
                <button class="modal-close" onclick="closeModal('costos')">‚úï</button>
            </div>
            
            <form onsubmit="actualizarCostos(event)">
                <div class="form-group">
                    <label class="form-label">Sabor</label>
                    <select id="saborCosto" class="form-select" required>
                        <option value="">Selecciona sabor</option>
                        <option value="fuego">üî• Fuego</option>
                        <option value="misterio">üåü Misterio</option>
                        <option value="habanero">ü´ë Habanero</option>
                        <option value="jalape√±o">üå∂Ô∏è Jalape√±o</option>
                        <option value="adobadas">üçÖ Adobadas</option>
                        <option value="naturales">üßÇ Naturales</option>
                        <option value="especias">‚ú® Especias</option>
                        <option value="chipotle">üî• Chipotle</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tama√±o</label>
                    <select id="tama√±oCosto" class="form-select" required>
                        <option value="">Selecciona tama√±o</option>
                        <option value="50">50g</option>
                        <option value="100">100g</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Costo de producci√≥n</label>
                    <input type="number" id="costoProduccion" class="form-input" step="0.01" min="0" required>
                </div>
                
                <button type="submit" class="btn btn-primary">
                    <span>üí∞</span>
                    <span>Actualizar Costo</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- Reportes Modal -->
    <div id="modalReportes" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìä Reportes</h3>
                <button class="modal-close" onclick="closeModal('reportes')">‚úï</button>
            </div>
            
            <div id="reportesContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tendencias Modal -->
    <div id="modalTendencias" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üìà Tendencias</h3>
                <button class="modal-close" onclick="closeModal('tendencias')">‚úï</button>
            </div>
            
            <div id="tendenciasContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Flujo Efectivo Modal -->
    <div id="modalFlujoEfectivo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">üíµ Flujo de Efectivo</h3>
                <button class="modal-close" onclick="closeModal('flujoEfectivo')">‚úï</button>
            </div>
            
            <div id="flujoEfectivoContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cancelar Venta Modal -->
    <div id="modalCancelarVenta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ùå Cancelar Venta</h3>
                <button class="modal-close" onclick="closeModal('cancelarVenta')">‚úï</button>
            </div>
            
            <div id="cancelarVentaContent">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBA6Wjrf9sbRMcSmE-_If7Ecd_RkybwlgY",
            authDomain: "malanguisimas-992db.firebaseapp.com",
            projectId: "malanguisimas-992db",
            storageBucket: "malanguisimas-992db.firebasestorage.app",
            messagingSenderId: "279815762562",
            appId: "1:279815762562:web:d77520d7a09ac3b36bfa9b",
            measurementId: "G-6ERTR0YGT4"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Constants
        const CODIGO_ACCESO = "MALCH2025";
        const TIMEZONE = 'America/Mexico_City';
        
        // Global State
        let sistemaData = {
            inventario: {},
            costos_unitarios: {},
            ventas: [],
            regaladas: [],
            gastos: [],
            ajustes: [],
            conversiones: [],
            envios: [],
            recepciones: [],
            sabores: ['fuego', 'misterio', 'habanero', 'jalape√±o', 'adobadas', 'naturales', 'especias', 'chipotle'],
            tama√±os: [50, 100],
            precios_mayoreo: {50: 20.0, 100: 33.0},
            precios_menudeo: {50: 25.0, 100: 40.0},
            precios_compra: {50: 15.0, 100: 23.0}
        };
        
        let currentTab = 'Inicio';
        let pullDistance = 0;
        let isPulling = false;
        let carritoVenta = [];
        let carritoRecepcion = [];
        let tipoVentaActual = 'menudeo';
        
        // Authentication
        function checkAuth() {
            const isAuth = sessionStorage.getItem('malanguisimas_auth') === 'true';
            if (isAuth) {
                showApp();
                loadData();
            }
        }
        
        function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('loginPassword').value;
            
            if (password === CODIGO_ACCESO) {
                sessionStorage.setItem('malanguisimas_auth', 'true');
                showApp();
                loadData();
                
                // Get current hour for greeting
                const hour = new Date().getHours();
                let greeting = '¬°Buenos d√≠as!';
                if (hour >= 12 && hour < 19) greeting = '¬°Buenas tardes!';
                else if (hour >= 19) greeting = '¬°Buenas noches!';
                
                showToast(`${greeting} Bienvenido a Malangu√≠simas üå∂Ô∏è`, 'success');
            } else {
                showToast('‚ùå C√≥digo incorrecto', 'error');
                document.getElementById('loginPassword').value = '';
            }
        }
        
        function logout() {
            if (confirm('¬øEst√°s seguro de cerrar sesi√≥n?')) {
                sessionStorage.removeItem('malanguisimas_auth');
                location.reload();
            }
        }
        
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            
            // Restore last tab if available
            const lastTab = localStorage.getItem('malanguisimas_lastTab');
            if (lastTab && ['Inicio', 'Inventario', 'Ventas', 'Mas'].includes(lastTab)) {
                // Find and click the corresponding nav button
                const navButtons = document.querySelectorAll('.nav-item');
                navButtons.forEach(button => {
                    if (button.querySelector('.label').textContent === lastTab) {
                        button.click();
                    }
                });
            }
        }
        
        // Tab Navigation
        function switchTab(tabName) {
            // Update nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');
            
            // Update tab views
            document.querySelectorAll('.tab-view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`tab${tabName}`).classList.add('active');
            
            currentTab = tabName;
            
            // Save current tab preference
            localStorage.setItem('malanguisimas_lastTab', tabName);
            
            // Load specific tab data if needed
            if (tabName === 'Inventario') {
                loadInventario();
            } else if (tabName === 'Ventas') {
                loadHistorialVentas();
            }
            
            // Vibrate for feedback
            vibrate(5);
        }
        
        // Modal Management
        function showModal(modalName) {
            const modal = document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`);
            if (modal) {
                modal.style.display = 'block';
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
            }
        }
        
        function closeModal(modalName) {
            const modal = document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`);
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.style.display = 'none';
                }, 300);
                
                // Clear forms and data when closing modals
                switch(modalName) {
                    case 'ventaMultiple':
                        carritoVenta = [];
                        actualizarVistaCarrito();
                        break;
                    case 'recepcion':
                        carritoRecepcion = [];
                        actualizarVistaRecepcion();
                        break;
                    case 'quitarStock':
                        document.getElementById('stockActualInfo').style.display = 'none';
                        break;
                    case 'convertir':
                        document.getElementById('stockConversionInfo').style.display = 'none';
                        break;
                    case 'envio':
                        calcularTotalEnvio();
                        break;
                }
            }
        }
        
        // Utility Functions
        function vibrate(pattern = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }
        
        // Toast Notifications
        function showToast(message, type = 'success') {
            vibrate();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type]}</span>
                <span class="toast-message">${message}</span>
            `;
            
            document.getElementById('toastContainer').appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideDown 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Sync Status
        function updateSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            indicator.classList.remove('offline', 'syncing');
            
            switch(status) {
                case 'online':
                    break;
                case 'offline':
                    indicator.classList.add('offline');
                    break;
                case 'syncing':
                    indicator.classList.add('syncing');
                    break;
            }
        }
        
        // Data Loading
        async function loadData() {
            try {
                updateSyncStatus('syncing');
                
                // Load inventory
                const inventarioSnap = await db.collection('inventario').get();
                sistemaData.inventario = {};
                inventarioSnap.forEach(doc => {
                    sistemaData.inventario[doc.id] = doc.data().cantidad;
                });
                
                // Load costs
                const costosSnap = await db.collection('costos').get();
                sistemaData.costos_unitarios = {};
                costosSnap.forEach(doc => {
                    sistemaData.costos_unitarios[doc.id] = doc.data().costo;
                });
                
                // Load recent sales
                const ventasSnap = await db.collection('ventas')
                    .orderBy('fecha', 'desc')
                    .limit(50)
                    .get();
                sistemaData.ventas = [];
                ventasSnap.forEach(doc => {
                    sistemaData.ventas.push({id: doc.id, ...doc.data()});
                });
                
                // Load other collections
                const [regaladashSnap, gastosSnap, ajustesSnap, conversionesSnap, enviosSnap, recepcionesSnap] = await Promise.all([
                    db.collection('regaladas').orderBy('fecha', 'desc').limit(50).get(),
                    db.collection('gastos').orderBy('fecha', 'desc').limit(50).get(),
                    db.collection('ajustes').orderBy('fecha', 'desc').limit(50).get(),
                    db.collection('conversiones').orderBy('fecha', 'desc').limit(50).get(),
                    db.collection('envios').orderBy('fecha', 'desc').limit(50).get(),
                    db.collection('recepciones').orderBy('fecha_recepcion', 'desc').limit(50).get()
                ]);
                
                sistemaData.regaladas = [];
                regaladashSnap.forEach(doc => {
                    sistemaData.regaladas.push({id: doc.id, ...doc.data()});
                });
                
                sistemaData.gastos = [];
                gastosSnap.forEach(doc => {
                    sistemaData.gastos.push({id: doc.id, ...doc.data()});
                });
                
                sistemaData.ajustes = [];
                ajustesSnap.forEach(doc => {
                    sistemaData.ajustes.push({id: doc.id, ...doc.data()});
                });
                
                sistemaData.conversiones = [];
                conversionesSnap.forEach(doc => {
                    sistemaData.conversiones.push({id: doc.id, ...doc.data()});
                });
                
                sistemaData.envios = [];
                enviosSnap.forEach(doc => {
                    sistemaData.envios.push({id: doc.id, ...doc.data()});
                });
                
                sistemaData.recepciones = [];
                recepcionesSnap.forEach(doc => {
                    sistemaData.recepciones.push({id: doc.id, ...doc.data()});
                });
                
                // Initialize products if needed
                if (Object.keys(sistemaData.inventario).length === 0) {
                    await initializeProducts();
                }
                
                updateStats();
                updateSyncStatus('online');
                updateLastSync();
                
                // Load current tab data
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('‚ö†Ô∏è Error al cargar datos', 'error');
                updateSyncStatus('offline');
            }
        }
        
        async function initializeProducts() {
            const batch = db.batch();
            
            sistemaData.sabores.forEach(sabor => {
                sistemaData.tama√±os.forEach(tama√±o => {
                    const codigo = `${sabor}_${tama√±o}g`;
                    
                    const invRef = db.collection('inventario').doc(codigo);
                    batch.set(invRef, { cantidad: 0 });
                    
                    const costoRef = db.collection('costos').doc(codigo);
                    batch.set(costoRef, { costo: sistemaData.precios_compra[tama√±o] });
                    
                    sistemaData.inventario[codigo] = 0;
                    sistemaData.costos_unitarios[codigo] = sistemaData.precios_compra[tama√±o];
                });
            });
            
            await batch.commit();
        }
        
        // Sync Data
        async function syncData() {
            await loadData();
            showToast('‚úÖ Datos sincronizados', 'success');
        }
        
        // Update Stats
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            
            const ventasHoy = sistemaData.ventas.filter(venta => 
                venta.fecha.split('T')[0] === today && !venta.cancelada
            );
            
            const enviosHoy = sistemaData.envios.filter(envio => 
                envio.fecha.split('T')[0] === today
            );
            
            let totalVentas = 0;
            let totalIngresos = 0;
            
            ventasHoy.forEach(venta => {
                if (venta.productos && Array.isArray(venta.productos)) {
                    totalVentas += venta.cantidad_total || venta.productos.reduce((sum, p) => sum + p.cantidad, 0);
                } else {
                    totalVentas += venta.cantidad || 0;
                }
                totalIngresos += venta.total_venta || 0;
            });
            
            enviosHoy.forEach(envio => {
                totalVentas += envio.cantidad || 0;
                totalIngresos += envio.total_venta || 0;
            });
            
            let productosEnStock = 0;
            Object.values(sistemaData.inventario).forEach(stock => {
                if (stock > 0) productosEnStock++;
            });
            
            document.getElementById('ventasHoy').textContent = totalVentas;
            document.getElementById('ingresosHoy').textContent = `${totalIngresos.toFixed(0)}`;
            document.getElementById('productosStock').textContent = productosEnStock;
            
            // Update recent activity
            updateRecentActivity();
        }
        
        function updateLastSync() {
            const now = new Date();
            const time = now.toLocaleTimeString('es-MX', {
                timeZone: TIMEZONE,
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('ultimaSync').textContent = time;
        }
        
        // Load Inventory
        function loadInventario() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            Object.entries(sistemaData.inventario).forEach(([codigo, stock]) => {
                const [sabor, tama√±oStr] = codigo.split('_');
                const tama√±o = parseInt(tama√±oStr);
                const saborTitulo = sabor.charAt(0).toUpperCase() + sabor.slice(1);
                
                let stockClass, stockText;
                if (stock > 10) {
                    stockClass = 'stock-good';
                    stockText = 'En Stock';
                } else if (stock > 0) {
                    stockClass = 'stock-low';
                    stockText = 'Stock Bajo';
                } else {
                    stockClass = 'stock-out';
                    stockText = 'Agotado';
                }
                
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <div class="product-name">${saborTitulo} ${tama√±o}g</div>
                    <div class="product-stock">
                        <span>${stock} unidades</span>
                        <span class="stock-badge ${stockClass}">${stockText}</span>
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }
        
        // Search Products
        function buscarProducto(query) {
            const cards = document.querySelectorAll('.product-card');
            const searchTerm = query.toLowerCase();
            
            cards.forEach(card => {
                const productName = card.querySelector('.product-name').textContent.toLowerCase();
                if (productName.includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Update Recent Activity
        function updateRecentActivity() {
            const container = document.getElementById('actividadReciente');
            
            // Combine all recent activities
            let actividades = [];
            
            // Add ventas
            sistemaData.ventas.filter(v => !v.cancelada).slice(0, 5).forEach(venta => {
                actividades.push({
                    fecha: venta.fecha,
                    tipo: 'venta',
                    descripcion: venta.productos ? 
                        venta.productos.map(p => `${p.sabor} ${p.tama√±o}g x${p.cantidad}`).join(', ') :
                        `${venta.producto} x${venta.cantidad}`,
                    monto: venta.total_venta,
                    icon: venta.tipo_venta === 'mayoreo' ? 'üè™' : 'üõí'
                });
            });
            
            // Add envios
            sistemaData.envios.slice(0, 3).forEach(envio => {
                actividades.push({
                    fecha: envio.fecha,
                    tipo: 'envio',
                    descripcion: `Env√≠o a ${envio.cliente}: ${envio.producto} x${envio.cantidad}`,
                    monto: envio.total_venta,
                    icon: 'üì¶'
                });
            });
            
            // Add regaladas
            sistemaData.regaladas.slice(0, 2).forEach(regalada => {
                actividades.push({
                    fecha: regalada.fecha,
                    tipo: 'regalada',
                    descripcion: `Muestra: ${regalada.producto} x${regalada.cantidad}`,
                    monto: 0,
                    icon: 'üéÅ'
                });
            });
            
            // Sort by date
            actividades.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            if (actividades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-text">Sin actividad reciente</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            actividades.slice(0, 5).forEach(item => {
                const fecha = new Date(item.fecha);
                const timeStr = fecha.toLocaleTimeString('es-MX', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const color = item.tipo === 'regalada' ? 'var(--warning)' : 'var(--success)';
                
                html += `
                    <div style="padding: 12px 0; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between;">
                            <div style="flex: 1;">
                                <div style="font-weight: 500;">
                                    <span style="margin-right: 8px;">${item.icon}</span>${item.descripcion}
                                </div>
                                <div style="font-size: 0.9em; color: var(--text-light);">${timeStr}</div>
                            </div>
                            ${item.monto > 0 ? `
                                <div style="font-weight: bold; color: ${color}; white-space: nowrap; margin-left: 12px;">
                                    ${item.monto.toFixed(2)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Sales Functions
        function prepararVenta(tipo) {
            tipoVentaActual = tipo;
            carritoVenta = [];
            document.getElementById('tituloVentaMultiple').textContent = tipo === 'menudeo' ? 'üõí Venta Menudeo' : 'üè™ Venta Mayoreo';
            actualizarVistaCarrito();
            showModal('ventaMultiple');
        }
        
        function actualizarPrecioVenta() {
            const tipo = document.getElementById('tipoVentaRapida').value;
            const tama√±o = parseInt(document.getElementById('tama√±oVenta').value) || 0;
            const cantidad = parseInt(document.getElementById('cantidadVenta').value) || 0;
            
            if (tama√±o && cantidad) {
                const precio = tipo === 'mayoreo' ? 
                    sistemaData.precios_mayoreo[tama√±o] : 
                    sistemaData.precios_menudeo[tama√±o];
                
                const total = precio * cantidad;
                document.getElementById('totalVentaRapida').textContent = `${total.toFixed(2)}`;
            } else {
                document.getElementById('totalVentaRapida').textContent = '$0.00';
            }
        }
        
        async function procesarVentaRapida(event) {
            event.preventDefault();
            
            const tipo = document.getElementById('tipoVentaRapida').value;
            const sabor = document.getElementById('saborVenta').value;
            const tama√±o = parseInt(document.getElementById('tama√±oVenta').value);
            const cantidad = parseInt(document.getElementById('cantidadVenta').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                showToast(`‚ùå Stock insuficiente! Disponible: ${stockActual}`, 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                const precio = tipo === 'mayoreo' ? 
                    sistemaData.precios_mayoreo[tama√±o] : 
                    sistemaData.precios_menudeo[tama√±o];
                
                const total = precio * cantidad;
                const costo = (sistemaData.costos_unitarios[codigo] || 0) * cantidad;
                const ganancia = total - costo;
                
                const venta = {
                    fecha: new Date().toISOString(),
                    tipo_venta: tipo,
                    productos: [{
                        codigo: codigo,
                        sabor: sabor,
                        tama√±o: tama√±o,
                        cantidad: cantidad,
                        precio_unitario: precio,
                        subtotal: total
                    }],
                    total_venta: total,
                    costo_total: costo,
                    ganancia: ganancia,
                    cantidad_total: cantidad
                };
                
                const docRef = await db.collection('ventas').add(venta);
                venta.id = docRef.id;
                
                // Update inventory
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                // Update local data
                sistemaData.inventario[codigo] = stockActual - cantidad;
                sistemaData.ventas.unshift(venta);
                
                showToast(`‚úÖ Venta registrada: ${total.toFixed(2)}`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('ventaRapida');
                
                // Reset form
                event.target.reset();
                document.getElementById('totalVentaRapida').textContent = '$0.00';
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al registrar venta', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Carrito Functions
        function agregarAlCarrito() {
            const sabor = document.getElementById('saborCarrito').value;
            const tama√±o = parseInt(document.getElementById('tama√±oCarrito').value);
            const cantidad = parseInt(document.getElementById('cantidadCarrito').value);
            
            if (!sabor || !tama√±o || !cantidad || cantidad <= 0) {
                showToast('‚ùå Completa todos los campos', 'error');
                return;
            }
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            const enCarrito = carritoVenta
                .filter(item => item.codigo === codigo)
                .reduce((sum, item) => sum + item.cantidad, 0);
            
            if (stockActual < (cantidad + enCarrito)) {
                showToast(`‚ùå Stock insuficiente! Disponible: ${stockActual - enCarrito}`, 'error');
                return;
            }
            
            const precioUnitario = tipoVentaActual === 'menudeo' ? 
                sistemaData.precios_menudeo[tama√±o] : 
                sistemaData.precios_mayoreo[tama√±o];
            
            const item = {
                codigo: codigo,
                sabor: sabor,
                tama√±o: tama√±o,
                cantidad: cantidad,
                precioUnitario: precioUnitario,
                costoUnitario: sistemaData.costos_unitarios[codigo] || 0,
                subtotal: precioUnitario * cantidad
            };
            
            carritoVenta.push(item);
            actualizarVistaCarrito();
            
            // Clear fields
            document.getElementById('saborCarrito').value = '';
            document.getElementById('tama√±oCarrito').value = '';
            document.getElementById('cantidadCarrito').value = '';
            
            showToast('‚úÖ Agregado al carrito', 'success');
        }
        
        function quitarDelCarrito(index) {
            carritoVenta.splice(index, 1);
            actualizarVistaCarrito();
        }
        
        function actualizarVistaCarrito() {
            const carritoDiv = document.getElementById('carritoVenta');
            
            if (carritoVenta.length === 0) {
                carritoDiv.innerHTML = '<div class="cart-empty">Carrito vac√≠o</div>';
                document.getElementById('btnConfirmarVenta').disabled = true;
                actualizarTotalesCarrito();
                return;
            }
            
            let html = '';
            carritoVenta.forEach((item, index) => {
                const saborTitulo = item.sabor.charAt(0).toUpperCase() + item.sabor.slice(1);
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${saborTitulo} ${item.tama√±o}g</strong> x${item.cantidad}
                            <br><small>${item.precioUnitario.toFixed(2)} = ${item.subtotal.toFixed(2)}</small>
                        </div>
                        <button class="cart-remove" onclick="quitarDelCarrito(${index})">‚úï</button>
                    </div>
                `;
            });
            
            carritoDiv.innerHTML = html;
            document.getElementById('btnConfirmarVenta').disabled = false;
            actualizarTotalesCarrito();
        }
        
        function actualizarTotalesCarrito() {
            let subtotal = 0;
            let costoTotal = 0;
            
            carritoVenta.forEach(item => {
                subtotal += item.subtotal;
                costoTotal += item.costoUnitario * item.cantidad;
            });
            
            const ganancia = subtotal - costoTotal;
            
            document.getElementById('subtotalVenta').textContent = subtotal.toFixed(2);
            document.getElementById('totalVentaMultiple').textContent = subtotal.toFixed(2);
        }
        
        async function confirmarVentaMultiple() {
            if (carritoVenta.length === 0) {
                showToast('‚ùå El carrito est√° vac√≠o', 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                let totalVenta = 0;
                let costoTotal = 0;
                
                carritoVenta.forEach(item => {
                    totalVenta += item.subtotal;
                    costoTotal += item.costoUnitario * item.cantidad;
                });
                
                const ganancia = totalVenta - costoTotal;
                
                const productos = carritoVenta.map(item => ({
                    codigo: item.codigo,
                    sabor: item.sabor,
                    tama√±o: item.tama√±o,
                    cantidad: item.cantidad,
                    precio_unitario: item.precioUnitario,
                    subtotal: item.subtotal
                }));
                
                const venta = {
                    fecha: new Date().toISOString(),
                    tipo_venta: tipoVentaActual,
                    productos: productos,
                    total_venta: totalVenta,
                    costo_total: costoTotal,
                    costo_personalizado: false,
                    ganancia: ganancia,
                    cantidad_total: carritoVenta.reduce((sum, item) => sum + item.cantidad, 0)
                };
                
                const docRef = await db.collection('ventas').add(venta);
                venta.id = docRef.id;
                
                // Update inventory
                const batch = db.batch();
                for (const item of carritoVenta) {
                    const stockActual = sistemaData.inventario[item.codigo];
                    const invRef = db.collection('inventario').doc(item.codigo);
                    batch.set(invRef, { cantidad: stockActual - item.cantidad });
                    
                    sistemaData.inventario[item.codigo] = stockActual - item.cantidad;
                }
                await batch.commit();
                
                sistemaData.ventas.unshift(venta);
                
                const resumenProductos = carritoVenta.map(item => 
                    `${item.sabor} ${item.tama√±o}g x${item.cantidad}`
                ).join(', ');
                
                showToast(`‚úÖ Venta: ${resumenProductos} - Total: ${totalVenta.toFixed(2)}`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('ventaMultiple');
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al registrar venta', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Add Stock
        async function agregarStock(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborStock').value;
            const tama√±o = parseInt(document.getElementById('tama√±oStock').value);
            const cantidad = parseInt(document.getElementById('cantidadStock').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            
            try {
                updateSyncStatus('syncing');
                
                const stockActual = sistemaData.inventario[codigo] || 0;
                
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual + cantidad
                });
                
                sistemaData.inventario[codigo] = stockActual + cantidad;
                
                showToast(`‚úÖ Stock agregado: ${cantidad} unidades`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('agregarStock');
                
                event.target.reset();
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al agregar stock', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Quitar Stock
        function mostrarStockActual() {
            const sabor = document.getElementById('saborQuitar').value;
            const tama√±o = document.getElementById('tama√±oQuitar').value;
            
            if (sabor && tama√±o) {
                const codigo = `${sabor}_${tama√±o}g`;
                const stockActual = sistemaData.inventario[codigo] || 0;
                
                document.getElementById('stockActualTexto').textContent = stockActual;
                document.getElementById('stockActualInfo').style.display = 'block';
                document.getElementById('cantidadQuitar').max = stockActual;
            } else {
                document.getElementById('stockActualInfo').style.display = 'none';
            }
        }
        
        async function quitarStock(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborQuitar').value;
            const tama√±o = parseInt(document.getElementById('tama√±oQuitar').value);
            const cantidad = parseInt(document.getElementById('cantidadQuitar').value);
            const motivo = document.getElementById('motivoQuitar').value;
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                showToast(`‚ùå Stock insuficiente! Actual: ${stockActual}`, 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                const ajuste = {
                    fecha: new Date().toISOString(),
                    producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} ${tama√±o}g`,
                    codigo: codigo,
                    cantidad: -cantidad,
                    motivo: motivo,
                    tipo: 'reduccion'
                };
                
                const docRef = await db.collection('ajustes').add(ajuste);
                ajuste.id = docRef.id;
                
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                sistemaData.ajustes.push(ajuste);
                sistemaData.inventario[codigo] = stockActual - cantidad;
                
                showToast(`‚ùå Quitadas ${cantidad} unidades - ${motivo}`, 'warning');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('quitarStock');
                
                event.target.reset();
                document.getElementById('stockActualInfo').style.display = 'none';
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al quitar stock', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Recepci√≥n
        function agregarARecepcion() {
            const sabor = document.getElementById('saborRecepcion').value;
            const tama√±o = parseInt(document.getElementById('tama√±oRecepcion').value);
            const cantidad = parseInt(document.getElementById('cantidadRecepcion').value);
            
            if (!sabor || !tama√±o || !cantidad || cantidad <= 0) {
                showToast('‚ùå Completa todos los campos', 'error');
                return;
            }
            
            const item = {
                codigo: `${sabor}_${tama√±o}g`,
                sabor: sabor,
                tama√±o: tama√±o,
                cantidad: cantidad
            };
            
            carritoRecepcion.push(item);
            actualizarVistaRecepcion();
            
            document.getElementById('saborRecepcion').value = '';
            document.getElementById('tama√±oRecepcion').value = '';
            document.getElementById('cantidadRecepcion').value = '';
            
            showToast('‚úÖ Producto agregado', 'success');
        }
        
        function quitarDeRecepcion(index) {
            carritoRecepcion.splice(index, 1);
            actualizarVistaRecepcion();
        }
        
        function actualizarVistaRecepcion() {
            const listaDiv = document.getElementById('listaRecepcion');
            
            if (carritoRecepcion.length === 0) {
                listaDiv.innerHTML = '<div class="cart-empty">Sin productos</div>';
                document.getElementById('btnConfirmarRecepcion').disabled = true;
                return;
            }
            
            let html = '';
            carritoRecepcion.forEach((item, index) => {
                const saborTitulo = item.sabor.charAt(0).toUpperCase() + item.sabor.slice(1);
                html += `
                    <div class="cart-item">
                        <div>
                            <strong>${saborTitulo} ${item.tama√±o}g</strong> x${item.cantidad}
                        </div>
                        <button class="cart-remove" onclick="quitarDeRecepcion(${index})">‚úï</button>
                    </div>
                `;
            });
            
            listaDiv.innerHTML = html;
            document.getElementById('btnConfirmarRecepcion').disabled = false;
        }
        
        async function registrarRecepcion(event) {
            event.preventDefault();
            
            if (carritoRecepcion.length === 0) {
                showToast('‚ùå Agrega productos a recibir', 'error');
                return;
            }
            
            const origen = document.getElementById('origenRecepcion').value;
            const guia = document.getElementById('guiaRecepcion').value;
            const costoEnvio = parseFloat(document.getElementById('costoEnvioRecepcion').value) || 0;
            
            let totalProductos = 0;
            const productos = carritoRecepcion.map(item => {
                totalProductos += item.cantidad;
                return {
                    codigo: item.codigo,
                    sabor: item.sabor,
                    tama√±o: item.tama√±o,
                    cantidad: item.cantidad
                };
            });
            
            const costoUnitario = totalProductos > 0 ? (costoEnvio / totalProductos) : 0;
            
            try {
                updateSyncStatus('syncing');
                
                const recepcion = {
                    fecha_recepcion: new Date().toISOString(),
                    fecha_registro: new Date().toISOString(),
                    origen: origen,
                    guia: guia,
                    productos: productos,
                    total_productos: totalProductos,
                    costo_envio: costoEnvio,
                    costo_unitario: costoUnitario,
                    notas: '',
                    estado: 'recibido'
                };
                
                const docRef = await db.collection('recepciones').add(recepcion);
                recepcion.id = docRef.id;
                
                const batch = db.batch();
                for (const producto of productos) {
                    const stockActual = sistemaData.inventario[producto.codigo] || 0;
                    const invRef = db.collection('inventario').doc(producto.codigo);
                    batch.set(invRef, { cantidad: stockActual + producto.cantidad });
                    
                    sistemaData.inventario[producto.codigo] = stockActual + producto.cantidad;
                    
                    if (costoUnitario > 0) {
                        const costoActual = sistemaData.costos_unitarios[producto.codigo] || 0;
                        const nuevoPromedio = (costoActual + costoUnitario) / 2;
                        
                        const costoRef = db.collection('costos').doc(producto.codigo);
                        batch.set(costoRef, { costo: nuevoPromedio });
                        
                        sistemaData.costos_unitarios[producto.codigo] = nuevoPromedio;
                    }
                }
                await batch.commit();
                
                sistemaData.recepciones.push(recepcion);
                
                showToast(`‚úÖ Recepci√≥n registrada - ${totalProductos} productos`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('recepcion');
                
                // Reset form
                event.target.reset();
                carritoRecepcion = [];
                actualizarVistaRecepcion();
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al registrar recepci√≥n', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Gastos
        async function registrarGasto(event) {
            event.preventDefault();
            
            const concepto = document.getElementById('conceptoGasto').value;
            const monto = parseFloat(document.getElementById('montoGasto').value);
            const categoria = document.getElementById('categoriaGasto').value;
            
            try {
                updateSyncStatus('syncing');
                
                const gasto = {
                    fecha: new Date().toISOString(),
                    concepto: concepto,
                    monto: monto,
                    categoria: categoria
                };
                
                const docRef = await db.collection('gastos').add(gasto);
                gasto.id = docRef.id;
                
                sistemaData.gastos.push(gasto);
                
                showToast(`‚úÖ Gasto registrado: ${monto.toFixed(2)}`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('gastos');
                
                event.target.reset();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al registrar gasto', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Env√≠os
        function calcularTotalEnvio() {
            const tama√±o = parseInt(document.getElementById('tama√±oEnvio').value) || 0;
            const cantidad = parseInt(document.getElementById('cantidadEnvio').value) || 0;
            const tipoPrecio = document.getElementById('tipoPrecioEnvio').value;
            const costoEnvio = parseFloat(document.getElementById('costoEnvio').value) || 0;
            
            if (tama√±o && cantidad) {
                const precioUnitario = tipoPrecio === 'mayoreo' ? 
                    sistemaData.precios_mayoreo[tama√±o] : 
                    sistemaData.precios_menudeo[tama√±o];
                
                const subtotal = precioUnitario * cantidad;
                const total = subtotal + costoEnvio;
                
                document.getElementById('subtotalEnvio').textContent = subtotal.toFixed(2);
                document.getElementById('costoEnvioMostrar').textContent = costoEnvio.toFixed(2);
                document.getElementById('totalEnvio').textContent = total.toFixed(2);
            } else {
                document.getElementById('subtotalEnvio').textContent = '0.00';
                document.getElementById('costoEnvioMostrar').textContent = costoEnvio.toFixed(2);
                document.getElementById('totalEnvio').textContent = costoEnvio.toFixed(2);
            }
        }
        
        async function registrarEnvio(event) {
            event.preventDefault();
            
            const cliente = document.getElementById('clienteEnvio').value;
            const sabor = document.getElementById('saborEnvio').value;
            const tama√±o = parseInt(document.getElementById('tama√±oEnvio').value);
            const cantidad = parseInt(document.getElementById('cantidadEnvio').value);
            const tipoPrecio = document.getElementById('tipoPrecioEnvio').value;
            const costoEnvio = parseFloat(document.getElementById('costoEnvio').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                showToast(`‚ùå Stock insuficiente! Disponible: ${stockActual}`, 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                const precioUnitario = tipoPrecio === 'mayoreo' ? 
                    sistemaData.precios_mayoreo[tama√±o] : 
                    sistemaData.precios_menudeo[tama√±o];
                
                const subtotal = precioUnitario * cantidad;
                const totalVenta = subtotal + costoEnvio;
                const costoProducto = (sistemaData.costos_unitarios[codigo] || 0) * cantidad;
                const ganancia = subtotal - costoProducto;
                
                const envio = {
                    fecha: new Date().toISOString(),
                    cliente: cliente,
                    producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} ${tama√±o}g`,
                    codigo: codigo,
                    cantidad: cantidad,
                    tipo_precio: tipoPrecio,
                    precio_unitario: precioUnitario,
                    subtotal: subtotal,
                    costo_envio: costoEnvio,
                    total_venta: totalVenta,
                    costo_producto: costoProducto,
                    ganancia: ganancia
                };
                
                const docRef = await db.collection('envios').add(envio);
                envio.id = docRef.id;
                
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                sistemaData.envios.push(envio);
                sistemaData.inventario[codigo] = stockActual - cantidad;
                
                showToast(`‚úÖ Env√≠o a ${cliente} - Total: ${totalVenta.toFixed(2)}`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('envio');
                
                event.target.reset();
                calcularTotalEnvio();
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al registrar env√≠o', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Regaladas
        async function registrarRegalada(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborRegalada').value;
            const tama√±o = parseInt(document.getElementById('tama√±oRegalada').value);
            const cantidad = parseInt(document.getElementById('cantidadRegalada').value);
            const puntoVenta = document.getElementById('puntoVentaRegalada').value;
            
            const codigo = `${sabor}_${tama√±o}g`;
            const stockActual = sistemaData.inventario[codigo] || 0;
            
            if (stockActual < cantidad) {
                showToast(`‚ùå Stock insuficiente! Disponible: ${stockActual}`, 'error');
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                const costoUnitario = sistemaData.costos_unitarios[codigo] || 0;
                const costoTotal = costoUnitario * cantidad;
                
                const regalada = {
                    fecha: new Date().toISOString(),
                    producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} ${tama√±o}g`,
                    codigo: codigo,
                    cantidad: cantidad,
                    punto_venta: puntoVenta,
                    costo_total: costoTotal
                };
                
                const docRef = await db.collection('regaladas').add(regalada);
                regalada.id = docRef.id;
                
                await db.collection('inventario').doc(codigo).set({
                    cantidad: stockActual - cantidad
                });
                
                sistemaData.regaladas.push(regalada);
                sistemaData.inventario[codigo] = stockActual - cantidad;
                
                showToast(`üéÅ Muestra registrada: ${cantidad}x ${sabor} ${tama√±o}g`, 'warning');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('regalada');
                
                event.target.reset();
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al registrar muestra', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Conversiones
        function actualizarInfoConversion() {
            const tipo = document.getElementById('tipoConversion').value;
            const labelCantidad = document.getElementById('labelCantidadConvertir');
            
            if (tipo === '100a50') {
                labelCantidad.textContent = 'Bolsas de 100g a convertir';
            } else if (tipo === '50a100') {
                labelCantidad.textContent = 'Pares de 50g a convertir';
            }
            
            mostrarStockConversion();
        }
        
        function mostrarStockConversion() {
            const tipo = document.getElementById('tipoConversion').value;
            const sabor = document.getElementById('saborConvertir').value;
            
            if (!tipo || !sabor) {
                document.getElementById('stockConversionInfo').style.display = 'none';
                return;
            }
            
            const codigo50 = `${sabor}_50g`;
            const codigo100 = `${sabor}_100g`;
            const stock50 = sistemaData.inventario[codigo50] || 0;
            const stock100 = sistemaData.inventario[codigo100] || 0;
            
            let stockOrigenTexto = '';
            let maxConversion = 0;
            
            if (tipo === '100a50') {
                stockOrigenTexto = `Stock actual de 100g: ${stock100} unidades`;
                maxConversion = stock100;
            } else {
                stockOrigenTexto = `Stock actual de 50g: ${stock50} unidades`;
                maxConversion = Math.floor(stock50 / 2);
            }
            
            document.getElementById('stockOrigenTexto').innerHTML = stockOrigenTexto;
            document.getElementById('cantidadConvertir').max = maxConversion;
            document.getElementById('stockConversionInfo').style.display = 'block';
            
            calcularResultadoConversion();
        }
        
        function calcularResultadoConversion() {
            const tipo = document.getElementById('tipoConversion').value;
            const cantidad = parseInt(document.getElementById('cantidadConvertir').value) || 0;
            
            if (!tipo || cantidad <= 0) {
                document.getElementById('conversionResultado').innerHTML = '';
                return;
            }
            
            let resultado = '';
            if (tipo === '100a50') {
                resultado = `Resultado: ${cantidad} de 100g ‚Üí ${cantidad * 2} de 50g`;
            } else {
                resultado = `Resultado: ${cantidad * 2} de 50g ‚Üí ${cantidad} de 100g`;
            }
            
            document.getElementById('conversionResultado').innerHTML = resultado;
        }
        
        async function convertirStock(event) {
            event.preventDefault();
            
            const tipo = document.getElementById('tipoConversion').value;
            const sabor = document.getElementById('saborConvertir').value;
            const cantidad = parseInt(document.getElementById('cantidadConvertir').value);
            
            const codigo50 = `${sabor}_50g`;
            const codigo100 = `${sabor}_100g`;
            
            try {
                updateSyncStatus('syncing');
                
                let conversion;
                
                if (tipo === '100a50') {
                    const stock100 = sistemaData.inventario[codigo100] || 0;
                    if (stock100 < cantidad) {
                        showToast('‚ùå Stock insuficiente', 'error');
                        return;
                    }
                    
                    conversion = {
                        fecha: new Date().toISOString(),
                        tipo: '100a50',
                        sabor: sabor,
                        de_producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} 100g`,
                        a_producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} 50g`,
                        cantidad_origen: cantidad,
                        cantidad_destino: cantidad * 2,
                        cantidad_convertida: cantidad
                    };
                    
                    await db.collection('inventario').doc(codigo100).set({
                        cantidad: stock100 - cantidad
                    });
                    
                    const stock50 = sistemaData.inventario[codigo50] || 0;
                    await db.collection('inventario').doc(codigo50).set({
                        cantidad: stock50 + (cantidad * 2)
                    });
                    
                    sistemaData.inventario[codigo100] = stock100 - cantidad;
                    sistemaData.inventario[codigo50] = stock50 + (cantidad * 2);
                    
                } else {
                    const stock50 = sistemaData.inventario[codigo50] || 0;
                    if (stock50 < (cantidad * 2)) {
                        showToast('‚ùå Stock insuficiente', 'error');
                        return;
                    }
                    
                    conversion = {
                        fecha: new Date().toISOString(),
                        tipo: '50a100',
                        sabor: sabor,
                        de_producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} 50g`,
                        a_producto: `${sabor.charAt(0).toUpperCase() + sabor.slice(1)} 100g`,
                        cantidad_origen: cantidad * 2,
                        cantidad_destino: cantidad,
                        cantidad_convertida: cantidad
                    };
                    
                    await db.collection('inventario').doc(codigo50).set({
                        cantidad: stock50 - (cantidad * 2)
                    });
                    
                    const stock100 = sistemaData.inventario[codigo100] || 0;
                    await db.collection('inventario').doc(codigo100).set({
                        cantidad: stock100 + cantidad
                    });
                    
                    sistemaData.inventario[codigo50] = stock50 - (cantidad * 2);
                    sistemaData.inventario[codigo100] = stock100 + cantidad;
                }
                
                const docRef = await db.collection('conversiones').add(conversion);
                conversion.id = docRef.id;
                sistemaData.conversiones.push(conversion);
                
                showToast(`‚úÖ Conversi√≥n realizada`, 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('convertir');
                
                event.target.reset();
                document.getElementById('stockConversionInfo').style.display = 'none';
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al convertir', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Actualizar Costos
        async function actualizarCostos(event) {
            event.preventDefault();
            
            const sabor = document.getElementById('saborCosto').value;
            const tama√±o = parseInt(document.getElementById('tama√±oCosto').value);
            const costo = parseFloat(document.getElementById('costoProduccion').value);
            
            const codigo = `${sabor}_${tama√±o}g`;
            
            try {
                updateSyncStatus('syncing');
                
                await db.collection('costos').doc(codigo).set({
                    costo: costo
                });
                
                sistemaData.costos_unitarios[codigo] = costo;
                
                const precioMayoreo = sistemaData.precios_mayoreo[tama√±o];
                const precioMenudeo = sistemaData.precios_menudeo[tama√±o];
                
                const margenMayoreo = ((precioMayoreo - costo) / precioMayoreo * 100).toFixed(1);
                const margenMenudeo = ((precioMenudeo - costo) / precioMenudeo * 100).toFixed(1);
                
                showToast(`‚úÖ Costo actualizado: ${costo.toFixed(2)}`, 'success');
                
                updateSyncStatus('online');
                closeModal('costos');
                
                event.target.reset();
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al actualizar costo', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Show Reports
        function showReportes() {
            showModal('reportes');
            generateReportes();
        }
        
        function generateReportes() {
            const today = new Date().toISOString().split('T')[0];
            const ventasHoy = sistemaData.ventas.filter(venta => 
                venta.fecha.split('T')[0] === today && !venta.cancelada
            );
            
            const regaladashHoy = sistemaData.regaladas.filter(r => 
                r.fecha.split('T')[0] === today
            );
            
            const enviosHoy = sistemaData.envios.filter(e => 
                e.fecha.split('T')[0] === today
            );
            
            let totalIngresos = 0;
            let totalCostos = 0;
            let totalGanancia = 0;
            let costoRegaladas = 0;
            
            let html = '<div style="padding: 20px;">';
            
            // Resumen del d√≠a
            html += '<div class="card" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">';
            html += '<h3 style="margin-bottom: 16px;">üìä Resumen del D√≠a</h3>';
            
            if (ventasHoy.length > 0 || enviosHoy.length > 0) {
                ventasHoy.forEach(venta => {
                    totalIngresos += venta.total_venta;
                    totalCostos += venta.costo_total;
                    totalGanancia += venta.ganancia;
                });
                
                enviosHoy.forEach(envio => {
                    totalIngresos += envio.total_venta;
                    totalGanancia += envio.ganancia;
                });
                
                regaladashHoy.forEach(regalada => {
                    costoRegaladas += regalada.costo_total;
                });
                
                const gananciaReal = totalGanancia - costoRegaladas;
                
                html += `
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div>
                            <div style="font-size: 1.5em; font-weight: bold;">${totalIngresos.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Ingresos</div>
                        </div>
                        <div>
                            <div style="font-size: 1.5em; font-weight: bold;">${gananciaReal.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Ganancia Neta</div>
                        </div>
                    </div>
                `;
            } else {
                html += '<p>No hay actividad registrada hoy</p>';
            }
            
            html += '</div>';
            
            // Detalle de ventas
            if (ventasHoy.length > 0) {
                html += '<h4 style="margin-top: 20px;">üí∞ Ventas del D√≠a</h4>';
                ventasHoy.forEach(venta => {
                    const fecha = new Date(venta.fecha);
                    const hora = fecha.toLocaleTimeString('es-MX', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    let productos = '';
                    if (venta.productos && Array.isArray(venta.productos)) {
                        productos = venta.productos.map(p => 
                            `${p.sabor} ${p.tama√±o}g x${p.cantidad}`
                        ).join(', ');
                    }
                    
                    html += `
                        <div class="card" style="margin-bottom: 12px;">
                            <div style="font-weight: 500;">${productos}</div>
                            <div style="display: flex; justify-content: space-between; margin-top: 8px;">
                                <span style="color: var(--text-light);">${hora}</span>
                                <span style="color: var(--success); font-weight: bold;">${venta.total_venta.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('reportesContent').innerHTML = html;
        }
        
        // Show Tendencias
        function showTendencias() {
            showModal('tendencias');
            generateTendencias();
        }
        
        function generateTendencias() {
            const ventasOrdenadas = [...sistemaData.ventas]
                .filter(v => !v.cancelada)
                .sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            if (ventasOrdenadas.length === 0) {
                document.getElementById('tendenciasContent').innerHTML = 
                    '<div class="empty-state"><div class="empty-icon">üìà</div><div class="empty-text">Sin datos para mostrar</div></div>';
                return;
            }
            
            // An√°lisis por producto
            const ventasPorProducto = {};
            const ventasPorSabor = {};
            
            ventasOrdenadas.forEach(venta => {
                if (venta.productos && Array.isArray(venta.productos)) {
                    venta.productos.forEach(producto => {
                        const key = `${producto.sabor}_${producto.tama√±o}g`;
                        
                        if (!ventasPorProducto[key]) {
                            ventasPorProducto[key] = {
                                sabor: producto.sabor,
                                tama√±o: producto.tama√±o,
                                cantidad: 0,
                                ingresos: 0
                            };
                        }
                        
                        if (!ventasPorSabor[producto.sabor]) {
                            ventasPorSabor[producto.sabor] = {
                                cantidad: 0,
                                ingresos: 0
                            };
                        }
                        
                        ventasPorProducto[key].cantidad += producto.cantidad;
                        ventasPorProducto[key].ingresos += producto.subtotal;
                        ventasPorSabor[producto.sabor].cantidad += producto.cantidad;
                        ventasPorSabor[producto.sabor].ingresos += producto.subtotal;
                    });
                }
            });
            
            const productosOrdenados = Object.entries(ventasPorProducto)
                .sort((a, b) => b[1].cantidad - a[1].cantidad);
            
            const saboresOrdenados = Object.entries(ventasPorSabor)
                .sort((a, b) => b[1].cantidad - a[1].cantidad);
            
            let html = '<div style="padding: 20px;">';
            
            // Top productos
            html += '<div class="card">';
            html += '<h4 style="margin-bottom: 16px;">üèÜ Productos M√°s Vendidos</h4>';
            
            productosOrdenados.slice(0, 5).forEach((item, index) => {
                const [codigo, datos] = item;
                const nombreProducto = `${datos.sabor.charAt(0).toUpperCase() + datos.sabor.slice(1)} ${datos.tama√±o}g`;
                
                html += `
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e0e0e0;">
                        <div>
                            <strong>${index + 1}. ${nombreProducto}</strong>
                            <br><small>${datos.cantidad} unidades</small>
                        </div>
                        <div style="text-align: right;">
                            <strong>${datos.ingresos.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Sabores populares
            html += '<div class="card" style="margin-top: 16px;">';
            html += '<h4 style="margin-bottom: 16px;">üå∂Ô∏è Sabores Populares</h4>';
            
            saboresOrdenados.forEach(([sabor, datos]) => {
                const nombreSabor = sabor.charAt(0).toUpperCase() + sabor.slice(1);
                const porcentaje = ((datos.cantidad / Object.values(ventasPorSabor).reduce((sum, s) => sum + s.cantidad, 0)) * 100).toFixed(1);
                
                html += `
                    <div style="margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <strong>${nombreSabor}</strong>
                            <span>${datos.cantidad} unidades (${porcentaje}%)</span>
                        </div>
                        <div style="background: #e0e0e0; height: 20px; border-radius: 10px; overflow: hidden;">
                            <div style="background: linear-gradient(to right, var(--primary), var(--secondary)); 
                                        width: ${porcentaje}%; height: 100%; transition: width 0.3s;">
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            html += '</div>';
            
            document.getElementById('tendenciasContent').innerHTML = html;
        }
        
        // Show Flujo Efectivo
        function showFlujoEfectivo() {
            showModal('flujoEfectivo');
            generateFlujoEfectivo();
        }
        
        function generateFlujoEfectivo() {
            let movimientos = [];
            
            // Agregar ventas
            sistemaData.ventas.forEach(venta => {
                if (!venta.cancelada) {
                    movimientos.push({
                        fecha: venta.fecha,
                        tipo: 'ingreso',
                        concepto: 'Venta',
                        monto: venta.total_venta,
                        categoria: 'venta'
                    });
                }
            });
            
            // Agregar env√≠os
            sistemaData.envios.forEach(envio => {
                movimientos.push({
                    fecha: envio.fecha,
                    tipo: 'ingreso',
                    concepto: `Env√≠o a ${envio.cliente}`,
                    monto: envio.total_venta,
                    categoria: 'envio'
                });
            });
            
            // Agregar gastos
            sistemaData.gastos.forEach(gasto => {
                movimientos.push({
                    fecha: gasto.fecha,
                    tipo: 'egreso',
                    concepto: gasto.concepto,
                    monto: gasto.monto,
                    categoria: 'gasto'
                });
            });
            
            // Agregar recepciones como egresos
            sistemaData.recepciones.forEach(recepcion => {
                if (recepcion.costo_envio > 0) {
                    movimientos.push({
                        fecha: recepcion.fecha_recepcion,
                        tipo: 'egreso',
                        concepto: `Recepci√≥n de ${recepcion.origen}`,
                        monto: recepcion.costo_envio,
                        categoria: 'recepcion'
                    });
                }
            });
            
            // Ordenar por fecha
            movimientos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Calcular totales
            let totalIngresos = 0;
            let totalEgresos = 0;
            
            movimientos.forEach(mov => {
                if (mov.tipo === 'ingreso') {
                    totalIngresos += mov.monto;
                } else {
                    totalEgresos += mov.monto;
                }
            });
            
            const balanceActual = totalIngresos - totalEgresos;
            
            let html = '<div style="padding: 20px;">';
            
            // Resumen
            html += `
                <div class="card" style="background: linear-gradient(135deg, #28a745, #20c997); color: white;">
                    <h4 style="margin-bottom: 16px;">üí∞ Resumen de Efectivo</h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div>
                            <div style="font-size: 1.3em; font-weight: bold;">${totalIngresos.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Total Ingresos</div>
                        </div>
                        <div>
                            <div style="font-size: 1.3em; font-weight: bold;">${totalEgresos.toFixed(2)}</div>
                            <div style="opacity: 0.9;">Total Gastos</div>
                        </div>
                    </div>
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <div style="font-size: 1.5em; font-weight: bold;">
                            ${balanceActual.toFixed(2)}
                        </div>
                        <div style="opacity: 0.9;">Balance Actual</div>
                    </div>
                </div>
            `;
            
            // Movimientos recientes
            html += '<h4 style="margin-top: 20px;">üìã Movimientos Recientes</h4>';
            
            movimientos.slice(0, 20).forEach(mov => {
                const fecha = new Date(mov.fecha);
                const fechaStr = fecha.toLocaleDateString('es-MX', {
                    day: 'numeric',
                    month: 'short',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const esIngreso = mov.tipo === 'ingreso';
                const color = esIngreso ? 'var(--success)' : 'var(--danger)';
                const signo = esIngreso ? '+' : '-';
                
                html += `
                    <div class="card" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${mov.concepto}</strong>
                                <br><small style="color: var(--text-light);">${fechaStr}</small>
                            </div>
                            <div style="text-align: right; color: ${color}; font-weight: bold;">
                                ${signo}${mov.monto.toFixed(2)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            document.getElementById('flujoEfectivoContent').innerHTML = html;
        }
        
        // Modal Cancelar Venta
        function showModal(modalName) {
            const modal = document.getElementById(`modal${modalName.charAt(0).toUpperCase() + modalName.slice(1)}`);
            if (modal) {
                modal.style.display = 'block';
                setTimeout(() => {
                    modal.classList.add('active');
                }, 10);
                
                // Special handling for certain modals
                if (modalName === 'cancelarVenta') {
                    mostrarVentasCancelables();
                }
            }
        }
        
        function mostrarVentasCancelables() {
            const ventasRecientes = [...sistemaData.ventas]
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
                .slice(0, 20);
            
            let html = '<div style="padding: 20px;">';
            
            if (ventasRecientes.length === 0) {
                html += '<div class="empty-state"><div class="empty-icon">üí∞</div><div class="empty-text">No hay ventas</div></div>';
            } else {
                html += '<h4>√öltimas 20 Ventas</h4>';
                
                ventasRecientes.forEach(venta => {
                    if (!venta.cancelada) {
                        const fecha = new Date(venta.fecha);
                        const fechaStr = fecha.toLocaleString('es-MX', {
                            day: 'numeric',
                            month: 'short',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        let detalleProductos = '';
                        if (venta.productos && Array.isArray(venta.productos)) {
                            detalleProductos = venta.productos.map(p => 
                                `${p.sabor} ${p.tama√±o}g x${p.cantidad}`
                            ).join(', ');
                        }
                        
                        html += `
                            <div class="card" style="margin-bottom: 12px;">
                                <div>
                                    <strong>${detalleProductos}</strong>
                                    <br><small>${fechaStr}</small>
                                    <br>Total: ${venta.total_venta.toFixed(2)}
                                </div>
                                <button class="btn btn-danger" style="margin-top: 12px;" 
                                        onclick="confirmarCancelacion('${venta.id}')">
                                    ‚ùå Cancelar Venta
                                </button>
                            </div>
                        `;
                    }
                });
            }
            
            html += '</div>';
            
            // Create modal content dynamically
            const modalContent = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">‚ùå Cancelar Venta</h3>
                        <button class="modal-close" onclick="closeModal('cancelarVenta')">‚úï</button>
                    </div>
                    ${html}
                </div>
            `;
            
            // Add modal if it doesn't exist
            let modal = document.getElementById('modalCancelarVenta');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalCancelarVenta';
                modal.className = 'modal';
                document.body.appendChild(modal);
            }
            modal.innerHTML = modalContent;
        }
        
        async function confirmarCancelacion(ventaId) {
            if (!confirm('¬øEst√°s seguro de cancelar esta venta? Se restaurar√° el inventario.')) {
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                const venta = sistemaData.ventas.find(v => v.id === ventaId);
                if (!venta || venta.cancelada) {
                    showToast('‚ùå Venta no encontrada o ya cancelada', 'error');
                    return;
                }
                
                // Restore inventory
                const batch = db.batch();
                
                if (venta.productos && Array.isArray(venta.productos)) {
                    for (const producto of venta.productos) {
                        const stockActual = sistemaData.inventario[producto.codigo] || 0;
                        const invRef = db.collection('inventario').doc(producto.codigo);
                        batch.set(invRef, { cantidad: stockActual + producto.cantidad });
                        
                        sistemaData.inventario[producto.codigo] = stockActual + producto.cantidad;
                    }
                }
                
                // Mark sale as cancelled
                const ventaRef = db.collection('ventas').doc(ventaId);
                batch.update(ventaRef, { 
                    cancelada: true, 
                    fecha_cancelacion: new Date().toISOString() 
                });
                
                await batch.commit();
                
                venta.cancelada = true;
                venta.fecha_cancelacion = new Date().toISOString();
                
                showToast('‚úÖ Venta cancelada', 'success');
                
                updateStats();
                updateSyncStatus('online');
                closeModal('cancelarVenta');
                
                if (currentTab === 'Inventario') {
                    loadInventario();
                }
                
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error al cancelar venta', 'error');
                updateSyncStatus('offline');
            }
        }
        
        // Pull to Refresh
        let touchStartY = 0;
        const mainContent = document.querySelector('.main-content');
        const pullIndicator = document.querySelector('.pull-to-refresh');
        const spinner = pullIndicator.querySelector('.spinner');
        
        mainContent.addEventListener('touchstart', (e) => {
            if (mainContent.scrollTop === 0) {
                touchStartY = e.touches[0].clientY;
            }
        });
        
        mainContent.addEventListener('touchmove', (e) => {
            if (mainContent.scrollTop === 0 && !isPulling) {
                const touchY = e.touches[0].clientY;
                pullDistance = Math.max(0, touchY - touchStartY);
                
                if (pullDistance > 60) {
                    spinner.style.display = 'block';
                    spinner.style.transform = `rotate(${pullDistance * 3}deg)`;
                }
            }
        });
        
        mainContent.addEventListener('touchend', async () => {
            if (pullDistance > 60 && !isPulling) {
                isPulling = true;
                spinner.style.transform = '';
                
                await syncData();
                
                spinner.style.display = 'none';
                isPulling = false;
            }
            pullDistance = 0;
        });
        
        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    const modalName = modal.id.replace('modal', '');
                    closeModal(modalName.charAt(0).toLowerCase() + modalName.slice(1));
                }
            });
        });
        
        // Initialize App
        window.onload = () => {
            checkAuth();
            
            // Prevent zoom on double tap
            let lastTouchEnd = 0;
            document.addEventListener('touchend', (e) => {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
            
            // Prevent pull-to-refresh on iOS when not at top
            document.body.addEventListener('touchmove', (e) => {
                if (mainContent.scrollTop > 0) {
                    e.preventDefault();
                }
            }, { passive: false });
        };
    </script>
</body>
</html>